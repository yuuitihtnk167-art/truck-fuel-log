<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>体脂肪計記録グラフアプリ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: #f5f5f5;
      color: #222;
    }

    h1 {
      font-size: 1.3rem;
      margin-bottom: 8px;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
    }

    .card {
      background: #fff;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.06);
    }

    .card-title {
      font-size: 1.1rem;
      margin-bottom: 8px;
      font-weight: 600;
    }

    form {
      display: grid;
      gap: 8px;
    }

    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .form-group {
      flex: 1;
      min-width: 120px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    label {
      font-size: 0.85rem;
    }

    input, select, button {
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
    }

    input:focus, select:focus, button:focus {
      outline: 2px solid #3b82f6;
      outline-offset: 1px;
    }

    button {
      cursor: pointer;
      border: none;
      background: #0f766e;
      color: #fff;
      font-weight: 600;
      padding: 8px 12px;
    }

    button.secondary {
      background: #6b7280;
    }

    button:disabled {
      opacity: 0.6;
      cursor: default;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 4px 6px;
      text-align: right;
      white-space: nowrap;
    }

    th {
      background: #f0f0f0;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    th:first-child, td:first-child {
      text-align: left;
    }

    .table-wrapper {
      max-height: 320px;
      overflow: auto;
    }

    .controls {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }

    .no-data {
      font-size: 0.85rem;
      color: #6b7280;
      margin-top: 4px;
    }

    @media (max-width: 700px) {
      body {
        padding: 8px;
      }
      .card {
        padding: 12px;
      }
      table {
        font-size: 0.7rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>体脂肪計記録グラフアプリ</h1>
      <p style="font-size:0.85rem; margin: 4px 0 0;">
        「日付・体重・BMI・体脂肪率・筋肉量・内臓脂肪・基礎代謝量・体内年齢」を入力して、
        項目ごとのグラフを表示します。
      </p>
    </div>

    <!-- 入力フォーム -->
    <div class="card">
      <div class="card-title">データ入力</div>
      <form id="entry-form">
        <div class="form-row">
          <div class="form-group">
            <label for="date">日付 *</label>
            <input type="date" id="date" required />
          </div>
          <div class="form-group">
            <label for="weight">体重 (kg)</label>
            <input type="number" id="weight" step="0.1" min="0" />
          </div>
          <div class="form-group">
            <label for="bmi">BMI</label>
            <input type="number" id="bmi" step="0.1" min="0" />
          </div>
          <div class="form-group">
            <label for="bodyFat">体脂肪率 (%)</label>
            <input type="number" id="bodyFat" step="0.1" min="0" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="muscle">筋肉量 (kg)</label>
            <input type="number" id="muscle" step="0.1" min="0" />
          </div>
          <div class="form-group">
            <label for="visceralFat">内臓脂肪</label>
            <input type="number" id="visceralFat" step="0.1" min="0" />
          </div>
          <div class="form-group">
            <label for="bmr">基礎代謝量</label>
            <input type="number" id="bmr" step="1" min="0" />
          </div>
          <div class="form-group">
            <label for="bodyAge">体内年齢</label>
            <input type="number" id="bodyAge" step="1" min="0" />
          </div>
        </div>

        <div class="form-row" style="margin-top:8px;">
          <button type="submit">データを追加</button>
          <button type="button" class="secondary" id="clear-data">
            すべて削除（localStorage）
          </button>
        </div>
      </form>
    </div>

    <!-- グラフ -->
    <div class="card">
      <div class="card-title">グラフ表示</div>
      <div class="controls">
        <label for="metric-select" style="font-size:0.9rem;">表示する項目:</label>
        <select id="metric-select">
          <option value="weight">体重 (kg)</option>
          <option value="bmi">BMI</option>
          <option value="bodyFat">体脂肪率 (%)</option>
          <option value="muscle">筋肉量 (kg)</option>
          <option value="visceralFat">内臓脂肪</option>
          <option value="bmr">基礎代謝量</option>
          <option value="bodyAge">体内年齢</option>
        </select>
      </div>
      <div style="height:260px;">
        <canvas id="chart"></canvas>
      </div>
      <div id="chart-no-data" class="no-data"></div>
    </div>

    <!-- 一覧テーブル -->
    <div class="card">
      <div class="card-title">記録一覧</div>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>日付</th>
              <th>体重 (kg)</th>
              <th>BMI</th>
              <th>体脂肪率 (%)</th>
              <th>筋肉量 (kg)</th>
              <th>内臓脂肪</th>
              <th>基礎代謝量</th>
              <th>体内年齢</th>
            </tr>
          </thead>
          <tbody id="data-tbody">
          </tbody>
        </table>
      </div>
      <div id="table-no-data" class="no-data"></div>
    </div>
  </div>

  <script>
    // --- データ構造 ---
    // {date, weight, bmi, bodyFat, muscle, visceralFat, bmr, bodyAge}
    const STORAGE_KEY = "bodyCompositionRecords_v2";

    /** @type {{
     *  date: string,
     *  weight: number|null,
     *  bmi: number|null,
     *  bodyFat: number|null,
     *  muscle: number|null,
     *  visceralFat: number|null,
     *  bmr: number|null,
     *  bodyAge: number|null
     * }[]} */
    let records = [];

    function loadFromStorage() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) {
        records = [];
        return;
      }
      try {
        const parsed = JSON.parse(raw);
        if (Array.isArray(parsed)) {
          records = parsed.map(r => ({
            date: r.date || "",
            weight: typeof r.weight === "number" ? r.weight : null,
            bmi: typeof r.bmi === "number" ? r.bmi : null,
            bodyFat: typeof r.bodyFat === "number" ? r.bodyFat : null,
            muscle: typeof r.muscle === "number" ? r.muscle : null,
            visceralFat: typeof r.visceralFat === "number" ? r.visceralFat : null,
            bmr: typeof r.bmr === "number" ? r.bmr : null,
            bodyAge: typeof r.bodyAge === "number" ? r.bodyAge : null,
          }));
        } else {
          records = [];
        }
      } catch (e) {
        console.error("storage parse error", e);
        records = [];
      }
    }

    function saveToStorage() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
    }

    // --- UI 要素 ---
    const form = document.getElementById("entry-form");
    const dateInput = document.getElementById("date");
    const weightInput = document.getElementById("weight");
    const bmiInput = document.getElementById("bmi");
    const bodyFatInput = document.getElementById("bodyFat");
    const muscleInput = document.getElementById("muscle");
    const visceralFatInput = document.getElementById("visceralFat");
    const bmrInput = document.getElementById("bmr");
    const bodyAgeInput = document.getElementById("bodyAge");
    const clearButton = document.getElementById("clear-data");

    const metricSelect = document.getElementById("metric-select");
    const chartNoData = document.getElementById("chart-no-data");
    const tableNoData = document.getElementById("table-no-data");
    const tbody = document.getElementById("data-tbody");

    // --- グラフ初期化 ---
    const ctx = document.getElementById("chart").getContext("2d");
    let chart = new Chart(ctx, {
      type: "line",
      data: {
        labels: [],
        datasets: [
          {
            label: "値",
            data: [],
            borderWidth: 2,
            tension: 0.2,
            pointRadius: 3
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            title: { display: true, text: "日付" }
          },
          y: {
            title: { display: true, text: "値" }
          }
        },
        plugins: {
          legend: { display: false }
        }
      }
    });

    function metricLabel(key) {
      switch (key) {
        case "weight": return "体重 (kg)";
        case "bmi": return "BMI";
        case "bodyFat": return "体脂肪率 (%)";
        case "muscle": return "筋肉量 (kg)";
        case "visceralFat": return "内臓脂肪";
        case "bmr": return "基礎代謝量";
        case "bodyAge": return "体内年齢";
        default: return "値";
      }
    }

    function updateChart() {
      const metric = metricSelect.value;
      if (!records.length) {
        chart.data.labels = [];
        chart.data.datasets[0].data = [];
        chart.update();
        chartNoData.textContent = "データがありません。先に入力してください。";
        return;
      }

      const sorted = [...records].sort((a, b) => a.date.localeCompare(b.date));

      const labels = [];
      const data = [];

      for (const r of sorted) {
        labels.push(r.date || "");
        const v = r[metric];
        data.push(typeof v === "number" ? v : null);
      }

      const hasAny = data.some(v => typeof v === "number");
      chart.data.labels = labels;
      chart.data.datasets[0].data = data;
      chart.data.datasets[0].label = metricLabel(metric);
      chart.options.scales.y.title.text = metricLabel(metric);
      chart.update();

      chartNoData.textContent = hasAny
        ? ""
        : "この項目の数値が入力されていません。";
    }

    function updateTable() {
      tbody.innerHTML = "";
      if (!records.length) {
        tableNoData.textContent = "まだ記録がありません。";
        return;
      }
      tableNoData.textContent = "";

      const sorted = [...records].sort((a, b) => a.date.localeCompare(b.date));

      for (const r of sorted) {
        const tr = document.createElement("tr");

        function td(text) {
          const el = document.createElement("td");
          el.textContent = text;
          return el;
        }

        tr.appendChild(td(r.date || ""));
        tr.appendChild(td(typeof r.weight === "number" ? r.weight.toFixed(1) : ""));
        tr.appendChild(td(typeof r.bmi === "number" ? r.bmi.toFixed(1) : ""));
        tr.appendChild(td(typeof r.bodyFat === "number" ? r.bodyFat.toFixed(1) : ""));
        tr.appendChild(td(typeof r.muscle === "number" ? r.muscle.toFixed(1) : ""));
        tr.appendChild(td(typeof r.visceralFat === "number" ? r.visceralFat.toFixed(1) : ""));
        tr.appendChild(td(typeof r.bmr === "number" ? r.bmr.toFixed(0) : ""));
        tr.appendChild(td(typeof r.bodyAge === "number" ? r.bodyAge.toFixed(0) : ""));

        tbody.appendChild(tr);
      }
    }

    // --- イベント ---

    form.addEventListener("submit", (e) => {
      e.preventDefault();

      const date = dateInput.value;
      if (!date) {
        alert("日付は必須です。");
        return;
      }

      const record = {
        date,
        weight: weightInput.value.trim() === "" ? null : Number(weightInput.value),
        bmi: bmiInput.value.trim() === "" ? null : Number(bmiInput.value),
        bodyFat: bodyFatInput.value.trim() === "" ? null : Number(bodyFatInput.value),
        muscle: muscleInput.value.trim() === "" ? null : Number(muscleInput.value),
        visceralFat: visceralFatInput.value.trim() === "" ? null : Number(visceralFatInput.value),
        bmr: bmrInput.value.trim() === "" ? null : Number(bmrInput.value),
        bodyAge: bodyAgeInput.value.trim() === "" ? null : Number(bodyAgeInput.value),
      };

      records.push(record);
      saveToStorage();
      updateTable();
      updateChart();

      // 日付だけ残して他はクリア
      weightInput.value = "";
      bmiInput.value = "";
      bodyFatInput.value = "";
      muscleInput.value = "";
      visceralFatInput.value = "";
      bmrInput.value = "";
      bodyAgeInput.value = "";
    });

    metricSelect.addEventListener("change", () => {
      updateChart();
    });

    clearButton.addEventListener("click", () => {
      if (!confirm("保存しているすべてのデータを削除しますか？")) {
        return;
      }
      records = [];
      saveToStorage();
      updateTable();
      updateChart();
    });

    function setToday() {
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, "0");
      const dd = String(today.getDate()).padStart(2, "0");
      dateInput.value = `${yyyy}-${mm}-${dd}`;
    }

    // --- 初期化 ---
    loadFromStorage();
    updateTable();
    updateChart();
    setToday();
  </script>
</body>
</html>
