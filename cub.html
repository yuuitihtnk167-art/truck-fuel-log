<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚«ãƒ–ç‡ƒè²»è¨˜éŒ²</title>
  <meta name="theme-color" content="#0f766e">
  <meta name="description" content="ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚«ãƒ–ç‡ƒè²»ç®¡ç†ã‚¢ãƒ—ãƒª">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ›µ</text></svg>">
  <style>
    :root {
      --primary-color: #0f766e;
      --secondary-color: #14b8a6;
      --accent-color: #f59e0b;
      --bg-color: #ecfeff;
      --text-color: #0f172a;
      --card-bg: #ffffff;
      --danger-color: #ef4444;
      --success-bg: #dcfce7;
      --success-text: #166534;
      --import-color: #059669;
    }
    * { box-sizing: border-box; touch-action: manipulation; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      margin: 0;
      padding: 0 0 80px;
      font-size: 16px;
    }
    header {
      background: linear-gradient(135deg, #0f766e, #14b8a6);
      color: #fff;
      padding: 1rem;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    header h1 { margin: 0; font-size: 1.1rem; }
    #sound-toggle {
      position: absolute;
      right: 15px;
      background: none;
      border: none;
      color: #fff;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 5px;
      opacity: 0.85;
    }
    #sound-toggle.muted {
      opacity: 0.5;
      text-decoration: line-through;
    }
    .container {
      max-width: 620px;
      margin: 0 auto;
      padding: 1rem;
    }
    .tabs {
      display: flex;
      background: #fff;
      padding: 0.4rem;
      border-radius: 10px;
      margin-bottom: 1rem;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .tab-btn {
      flex: 1;
      padding: 0.6rem;
      border: none;
      background: none;
      font-weight: 600;
      color: #64748b;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      border-radius: 6px 6px 0 0;
      font-size: 0.9rem;
    }
    .tab-btn.active {
      color: #0f766e;
      border-bottom-color: #0f766e;
    }
    .form-group { margin-bottom: 0.9rem; }
    label {
      display: block;
      margin-bottom: 0.3rem;
      font-weight: 600;
      color: #1e293b;
      font-size: 0.9rem;
    }
    input, textarea {
      width: 100%;
      padding: 0.7rem;
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      font-size: 1rem;
      background: #fff;
      -webkit-appearance: none;
      appearance: none;
    }
    input[type="file"] {
      padding: 0.4rem;
      font-size: 0.9rem;
      background: #f9fafb;
    }
    input:focus, textarea:focus {
      outline: none;
      border-color: #14b8a6;
      box-shadow: 0 0 0 3px rgba(45,212,191,0.25);
    }
    .btn {
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
      transition: filter 0.15s;
    }
    .btn:active { filter: brightness(0.95); }
    .btn-main {
      width: 100%;
      padding: 0.9rem;
      font-size: 1rem;
      background: #0f766e;
      color: #fff;
      margin-top: 0.3rem;
    }
    .btn-danger {
      padding: 0.35rem 0.6rem;
      font-size: 0.8rem;
      background: var(--danger-color);
      color: #fff;
    }
    .btn-small {
      padding: 0.35rem 0.6rem;
      font-size: 0.8rem;
      background: #64748b;
      color: #fff;
    }
    .btn-export {
      width: 100%;
      padding: 0.8rem;
      margin-top: 0.5rem;
      background: #10b981;
      color: #fff;
      font-size: 0.95rem;
    }
    .btn-import {
      width: 100%;
      padding: 0.7rem;
      margin-top: 0.4rem;
      background: var(--import-color);
      color: #fff;
      font-size: 0.9rem;
    }
    .btn-toggle-import {
      width: 100%;
      padding: 0.7rem;
      margin-bottom: 0.6rem;
      background: #64748b;
      color: #fff;
      font-size: 0.9rem;
    }
    .btn-full-danger {
      width: 100%;
      padding: 0.7rem;
      margin-top: 0.5rem;
      background: var(--danger-color);
      color: #fff;
      font-size: 0.9rem;
    }
    #fuel-preview-card {
      background: var(--success-bg);
      color: var(--success-text);
      padding: 0.8rem 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      border: 1px solid #86efac;
      font-size: 0.9rem;
      display: none;
    }
    #fuel-preview-card.visible { display: block; }
    .preview-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #14532d;
    }
    .preview-sub {
      font-size: 0.8rem;
      margin-top: 0.2rem;
    }
    .log-card {
      background: var(--card-bg);
      border-radius: 8px;
      padding: 0.9rem;
      margin-bottom: 0.9rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      border-left: 4px solid #14b8a6;
    }
    .log-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.4rem;
      padding-bottom: 0.3rem;
      border-bottom: 1px solid #e5e7eb;
    }
    .log-date {
      font-weight: 600;
      font-size: 0.95rem;
      color: #1f2937;
    }
    .log-actions {
      display: flex;
      gap: 0.3rem;
    }
    .log-main-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      margin-bottom: 0.4rem;
    }
    .log-km {
      font-size: 1.2rem;
      font-weight: 700;
      color: #0f766e;
    }
    .log-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.3rem 0.6rem;
      font-size: 0.85rem;
      color: #334155;
    }
    .log-stat-item span {
      display: block;
      font-size: 0.75rem;
      color: #6b7280;
    }
    .log-footer {
      margin-top: 0.4rem;
      font-size: 0.8rem;
      background: #f1f5f9;
      padding: 0.3rem 0.4rem;
      border-radius: 4px;
    }
    .fuel-badge {
      display: inline-block;
      background: #ccfbf1;
      color: #0f766e;
      padding: 0.15rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    .summary-card {
      background: #0f766e;
      color: #fff;
      border-radius: 10px;
      padding: 1.1rem 1rem 1rem;
      text-align: center;
      margin-bottom: 0.7rem;
    }
    .summary-main {
      font-size: 2rem;
      font-weight: 700;
      margin: 0.3rem 0;
    }
    .summary-sub {
      font-size: 0.9rem;
      opacity: 0.9;
    }
    .summary-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.6rem;
      margin-top: 0.7rem;
    }
    .summary-box {
      background: rgba(255,255,255,0.12);
      padding: 0.7rem;
      border-radius: 6px;
      font-size: 0.85rem;
    }
    .import-section {
      margin-top: 0.5rem;
      padding: 0.7rem;
      border-radius: 8px;
      border: 2px dashed #cbd5e1;
      background: #f8fafc;
      font-size: 0.8rem;
    }
    #notification {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #0f172a;
      color: #f9fafb;
      padding: 0.5rem 1rem;
      border-radius: 9999px;
      font-size: 0.8rem;
      display: none;
      z-index: 1000;
      box-shadow: 0 8px 20px rgba(0,0,0,0.4);
      white-space: nowrap;
    }
    .hidden { display: none; }
    small.hint { font-size: 0.75rem; color: #64748b; }
  </style>
</head>
<body>
<header>
  <h1>ğŸ›µ ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚«ãƒ–ç‡ƒè²»è¨˜éŒ²</h1>
  <button id="sound-toggle" onclick="toggleSound()">ğŸ”Š</button>
</header>

<div class="container">
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('input')">å…¥åŠ›</button>
    <button class="tab-btn" onclick="switchTab('list')">å±¥æ­´</button>
    <button class="tab-btn" onclick="switchTab('summary')">æœˆæ¬¡é›†è¨ˆ</button>
  </div>

  <div id="view-input" class="tab-content">
    <div id="fuel-preview-card">
      <div>ä»Šå›ã®è¨ˆç®—çµæœï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰</div>
      <div class="preview-value" id="preview-efficiency">-</div>
      <div class="preview-sub">
        èµ°è¡Œ: <span id="preview-distance">0</span> km /
        çµ¦æ²¹: <span id="preview-fuel">0</span> L
      </div>
    </div>

    <div class="log-card" style="border-left-color: var(--accent-color);">
      <form id="fuelForm">
        <div class="form-group">
          <label for="date">æ—¥ä»˜</label>
          <input type="date" id="date" required>
        </div>
        <div class="form-group">
          <label for="odometer">ã‚ªãƒ‰ãƒ¡ãƒ¼ã‚¿ãƒ¼ (km)</label>
          <input type="number" id="odometer" placeholder="ä¾‹: 56061.8" step="0.1" inputmode="decimal" required>
          <small id="last-odometer-hint" class="hint"></small>
        </div>
        <div class="form-group">
          <label for="fuel">çµ¦æ²¹é‡ (L)</label>
          <input type="number" id="fuel" step="0.01" inputmode="decimal" placeholder="ä¾‹: 3.65">
          <small class="hint">å°æ•°ç¬¬2ä½ã¾ã§å…¥åŠ›å¯ï¼ˆä¾‹: 3.65ï¼‰</small>
        </div>
        <div class="form-group">
          <label for="memo">ãƒ¡ãƒ¢</label>
          <textarea id="memo" rows="2" placeholder="çµ¦æ²¹å ´æ‰€ã‚„èµ°è¡Œæ¡ä»¶ãªã©"></textarea>
        </div>
        <button type="submit" class="btn btn-main" id="submitButton">
          ğŸ’¾ è¨˜éŒ²ã‚’è¿½åŠ ã™ã‚‹
        </button>
      </form>
    </div>
  </div>

  <div id="view-list" class="hidden tab-content">
    <button class="btn btn-toggle-import" onclick="toggleImportPanel()">
      ğŸ“¥ CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã‚’é–‹ã
    </button>

    <div id="import-panel" class="import-section hidden">
      <div style="color:var(--import-color); font-weight:600; margin-bottom:0.3rem;">
        ğŸ›µ CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼è‡ªå‹•åˆ¤å®šï¼‰
      </div>
      <div>â€»1è¡Œç›®ã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ã—ã¦ã€æ—¥ä»˜ãƒ»ã‚ªãƒ‰ãƒ»çµ¦æ²¹é‡ã®åˆ—ã‚’è‡ªå‹•ã§æ¢ã—ã¾ã™ã€‚</div>
      <input type="file" id="csvFile" accept=".csv">
      <button class="btn btn-import" onclick="importCSV()">ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ</button>
      <div style="margin-top:0.3rem; color:#64748b;">
        åƒåŒºåˆ‡ã‚Šä»˜ãæ•°å€¤ï¼ˆä¾‹: 56,061.80ï¼‰ã«ã‚‚å¯¾å¿œã—ã¾ã™ã€‚
      </div>
    </div>

    <div id="logs-container">
      <p style="text-align:center; color:#888; padding:1.5rem 0;">
        ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­â€¦
      </p>
    </div>

    <button class="btn btn-export" onclick="exportCSV()">ğŸ“¤ CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
    <button class="btn btn-full-danger" onclick="deleteAllLogs()">
      ğŸ—‘ï¸ å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
    </button>
  </div>

  <div id="view-summary" class="hidden tab-content">
    <div class="form-group">
      <label for="summaryMonth">è¡¨ç¤ºå¹´æœˆ</label>
      <input type="month" id="summaryMonth" onchange="renderSummary()">
    </div>
    <div id="summary-content">
      <p style="text-align:center; color:#888; padding:2rem 0;">
        å¹´æœˆã‚’é¸ã‚“ã§é›†è¨ˆã—ã¦ãã ã•ã„ã€‚
      </p>
    </div>
  </div>
</div>

<div id="notification">ä¿å­˜ã—ã¾ã—ãŸ</div>

<script>
  const DB_NAME = 'CubFuelDB';
  const DB_VERSION = 2;
  const STORE_NAME = 'logs';
  let db;
  let allLogs = [];
  let editingId = null;
  let isSoundOn = localStorage.getItem('cubAppSound') !== 'off';
  let audioCtx = null;

  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('date').valueAsDate = new Date();
    document.getElementById('summaryMonth').value = new Date().toISOString().slice(0, 7);
    initDB();
    updateSoundButton();

    ['odometer', 'fuel'].forEach(id => {
      document.getElementById(id).addEventListener('input', updatePreview);
    });

    document.getElementById('fuelForm').addEventListener('submit', handleSubmit);
  });

  function toggleSound() {
    isSoundOn = !isSoundOn;
    localStorage.setItem('cubAppSound', isSoundOn ? 'on' : 'off');
    updateSoundButton();
    if (isSoundOn) playHorn();
  }

  function updateSoundButton() {
    const btn = document.getElementById('sound-toggle');
    if (isSoundOn) {
      btn.textContent = 'ğŸ”Š';
      btn.classList.remove('muted');
    } else {
      btn.textContent = 'ğŸ”‡';
      btn.classList.add('muted');
    }
  }

  function playHorn() {
    if (!isSoundOn) return;
    if (!audioCtx) {
      const AC = window.AudioContext || window.webkitAudioContext;
      audioCtx = new AC();
    }
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const now = audioCtx.currentTime;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = 'triangle';
    osc.frequency.setValueAtTime(660, now);
    gain.gain.setValueAtTime(0, now);
    gain.gain.linearRampToValueAtTime(0.4, now + 0.03);
    gain.gain.exponentialRampToValueAtTime(0.01, now + 0.25);
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start(now);
    osc.stop(now + 0.25);
  }

  function initDB() {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = e => {
      db = e.target.result;
      if (!db.objectStoreNames.contains(STORE_NAME)) {
        const store = db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
        store.createIndex('date', 'date');
      }
    };
    req.onsuccess = e => { db = e.target.result; loadLogs(); };
    req.onerror = e => {
      console.error(e);
      showNotification('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒé–‹ã‘ã¾ã›ã‚“ã€‚');
    };
  }

  function handleSubmit(e) {
    e.preventDefault();
    const fuelVal = document.getElementById('fuel').value;
    const fuelNum = parseFloat(fuelVal);
    const odoNum = parseFloat(document.getElementById('odometer').value);

    if (!document.getElementById('date').value || isNaN(odoNum)) {
      showNotification('æ—¥ä»˜ã¨ã‚ªãƒ‰ãƒ¡ãƒ¼ã‚¿ãƒ¼ã¯å¿…é ˆã§ã™ã€‚');
      return;
    }
    if (fuelVal.trim() && isNaN(fuelNum)) {
      showNotification('çµ¦æ²¹é‡ãŒæ•°å€¤ã¨ã—ã¦èª­ã¿å–ã‚Œã¾ã›ã‚“ã€‚');
      return;
    }

    const data = {
      date: document.getElementById('date').value,
      odometer: odoNum,
      fuel: isNaN(fuelNum) ? 0 : fuelNum,
      memo: document.getElementById('memo').value,
      timestamp: Date.now()
    };

    if (editingId !== null) {
      updateLog(editingId, data);
    } else {
      addLog(data);
    }
  }

  function addLog(data) {
    if (!db) return;
    const tx = db.transaction([STORE_NAME], 'readwrite');
    tx.objectStore(STORE_NAME).add(data);
    tx.oncomplete = () => {
      playHorn();
      resetForm();
      loadLogs();
      showNotification('è¨˜éŒ²ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚');
    };
    tx.onerror = () => showNotification('è¨˜éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
  }

  function updateLog(id, data) {
    if (!db) return;
    const tx = db.transaction([STORE_NAME], 'readwrite');
    const store = tx.objectStore(STORE_NAME);
    const req = store.get(id);
    req.onsuccess = () => {
      const old = req.result;
      if (!old) { addLog(data); return; }
      const updated = { ...old, ...data, id };
      store.put(updated);
    };
    tx.oncomplete = () => {
      playHorn();
      resetForm();
      loadLogs();
      showNotification('è¨˜éŒ²ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚');
    };
    tx.onerror = () => showNotification('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
  }

  function resetForm() {
    editingId = null;
    document.getElementById('fuelForm').reset();
    document.getElementById('date').valueAsDate = new Date();
    document.getElementById('submitButton').textContent = 'ğŸ’¾ è¨˜éŒ²ã‚’è¿½åŠ ã™ã‚‹';
    document.getElementById('fuel-preview-card').classList.remove('visible');
  }

  function loadLogs() {
    if (!db) return;
    const tx = db.transaction([STORE_NAME], 'readonly');
    tx.objectStore(STORE_NAME).getAll().onsuccess = e => {
      const raw = e.target.result || [];
      raw.sort((a, b) => {
        if (a.date === b.date) return (a.odometer || 0) - (b.odometer || 0);
        return a.date < b.date ? -1 : 1;
      });
      let prev = null;
      allLogs = raw.map((log, idx) => {
        let distance = 0;
        let isFirst = false;
        if (idx === 0) {
          isFirst = true;
        } else if (prev && typeof prev.odometer === 'number') {
          const d = (log.odometer || 0) - (prev.odometer || 0);
          if (d > 0) distance = d;
          else isFirst = true;
        }
        const f = typeof log.fuel === 'number' ? log.fuel : 0;
        const totalFuel = f;
        const efficiency = distance > 0 && totalFuel > 0 ? distance / totalFuel : 0;
        const enriched = {
          ...log,
          fuel: f,
          distance,
          totalFuel,
          efficiency,
          isFirst
        };
        prev = enriched;
        return enriched;
      });

      if (allLogs.length > 0) {
        const last = allLogs[allLogs.length - 1];
        document.getElementById('last-odometer-hint').textContent =
          `æœ€æ–°ã®è¨˜éŒ²: ${last.date} / ${formatNumber(last.odometer)} km`;
      } else {
        document.getElementById('last-odometer-hint').textContent = 'ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
      }

      renderList();
      renderSummary();
      updatePreview();
    };
  }

  function updatePreview() {
    const card = document.getElementById('fuel-preview-card');
    if (allLogs.length === 0) {
      card.classList.remove('visible');
      return;
    }
    const odo = parseFloat(document.getElementById('odometer').value);
    const fuel = parseFloat(document.getElementById('fuel').value);

    if (!odo || isNaN(fuel) || fuel <= 0) {
      card.classList.remove('visible');
      return;
    }

    const temp = [...allLogs, {
      id: -1,
      date: document.getElementById('date').value || '',
      odometer: odo,
      fuel
    }];
    temp.sort((a, b) => {
      if (a.date === b.date) return (a.odometer || 0) - (b.odometer || 0);
      return a.date < b.date ? -1 : 1;
    });
    const idx = temp.findIndex(l => l.id === -1);
    if (idx <= 0) {
      card.classList.remove('visible');
      return;
    }
    const prev = temp[idx - 1];
    const dist = odo - (prev.odometer || 0);
    if (dist <= 0) {
      card.classList.remove('visible');
      return;
    }
    document.getElementById('preview-distance').textContent = formatNumber(dist);
    document.getElementById('preview-fuel').textContent = fuel.toFixed(2);
    document.getElementById('preview-efficiency').textContent = (dist / fuel).toFixed(2) + ' km/L';
    card.classList.add('visible');
  }

  function renderList() {
    const container = document.getElementById('logs-container');
    container.innerHTML = '';
    if (allLogs.length === 0) {
      container.innerHTML = '<p style="text-align:center; padding:2rem 0; color:#888;">ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
      return;
    }
    [...allLogs].slice().reverse().forEach(log => {
      const dateStr = log.date || '';
      const fuelText = log.totalFuel > 0 ? log.totalFuel.toFixed(2) : '-';
      const effText = log.isFirst || log.efficiency <= 0 ? '-' : log.efficiency.toFixed(2);
      const distText = log.isFirst || log.distance <= 0 ? '(åˆå›)' : '+' + formatNumber(log.distance) + ' km';
      const memoText = (log.memo || '').trim();
      container.insertAdjacentHTML('beforeend', `
        <div class="log-card">
          <div class="log-header">
            <span class="log-date">${escapeHtml(dateStr)}</span>
            <div class="log-actions">
              <button class="btn btn-small" onclick="editLog(${log.id})">ç·¨é›†</button>
              <button class="btn btn-danger" onclick="deleteLog(${log.id})">å‰Šé™¤</button>
            </div>
          </div>
          <div class="log-main-row">
            <div>
              <span style="font-size:0.8rem; color:#6b7280;">ä»Šå›ç‡ƒè²»</span><br>
              <span class="log-km">${effText}</span>
              <span style="font-size:0.85rem;">km/L</span>
            </div>
            <div style="text-align:right;">
              <span style="font-size:0.8rem; color:#6b7280;">èµ°è¡Œè·é›¢</span><br>
              <span style="font-weight:600;">${distText}</span>
            </div>
          </div>
          <div class="log-details">
            <div class="log-stat-item">
              <span>ã‚ªãƒ‰ãƒ¡ãƒ¼ã‚¿ãƒ¼</span>
              ${formatNumber(log.odometer)} km
            </div>
            <div class="log-stat-item">
              <span>çµ¦æ²¹é‡</span>
              <span class="fuel-badge">${fuelText} L</span>
            </div>
          </div>
          ${memoText ? `<div class="log-footer">${escapeHtml(memoText)}</div>` : ''}
        </div>
      `);
    });
  }

  function editLog(id) {
    const log = allLogs.find(l => l.id === id);
    if (!log) return;
    editingId = id;
    document.getElementById('date').value = log.date;
    document.getElementById('odometer').value = log.odometer;
    const f = log.fuel ?? log.totalFuel;
    document.getElementById('fuel').value = typeof f === 'number' && !isNaN(f) && f > 0 ? f : '';
    document.getElementById('memo').value = log.memo || '';
    document.getElementById('submitButton').textContent = 'âœï¸ è¨˜éŒ²ã‚’æ›´æ–°ã™ã‚‹';
    switchTab('input');
    updatePreview();
  }

  function deleteLog(id) {
    if (!db) return;
    if (!confirm('ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
    const tx = db.transaction([STORE_NAME], 'readwrite');
    tx.objectStore(STORE_NAME).delete(id);
    tx.oncomplete = () => {
      showNotification('å‰Šé™¤ã—ã¾ã—ãŸã€‚');
      loadLogs();
    };
  }

  function deleteAllLogs() {
    if (!db) return;
    if (!confirm('æœ¬å½“ã«å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
    const tx = db.transaction([STORE_NAME], 'readwrite');
    tx.objectStore(STORE_NAME).clear();
    tx.oncomplete = () => {
      allLogs = [];
      renderList();
      renderSummary();
      showNotification('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚');
    };
  }

  function renderSummary() {
    const month = document.getElementById('summaryMonth').value;
    const container = document.getElementById('summary-content');
    if (!month) return;
    const monthly = allLogs.filter(l => (l.date || '').startsWith(month));
    if (monthly.length === 0) {
      container.innerHTML = '<p style="text-align:center; padding:2rem 0; color:#888;">ãƒ‡ãƒ¼ã‚¿ãªã—</p>';
      return;
    }
    let dist = 0;
    let fuel = 0;
    monthly.forEach(l => {
      if (!l.isFirst && l.distance > 0 && l.totalFuel > 0) {
        dist += l.distance;
        fuel += l.totalFuel;
      }
    });
    const avg = dist > 0 && fuel > 0 ? (dist / fuel).toFixed(2) : '-';
    container.innerHTML = `
      <div class="summary-card">
        <div>æœˆ
