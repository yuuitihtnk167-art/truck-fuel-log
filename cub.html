<!DOCTYPE html>
<html lang="ja">
<head>
Â  <meta charset="UTF-8">
Â  <meta name="viewport"
Â  Â  Â  Â  content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
Â  <title>ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚«ãƒ–ç‡ƒè²»è¨˜éŒ²</title>
Â  <meta name="theme-color" content="#0f766e">
Â  <meta name="description" content="ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚«ãƒ–ç‡ƒè²»ç®¡ç†ã‚¢ãƒ—ãƒª">
Â  <link rel="manifest" href="manifest.webmanifest">
Â  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ›µ</text></svg>">
Â  <style>
Â  Â  :root {
Â  Â  Â  --primary-color: #0f766e;
Â  Â  Â  --secondary-color: #14b8a6;
Â  Â  Â  --accent-color: #f59e0b;
Â  Â  Â  --bg-color: #ecfeff;
Â  Â  Â  --text-color: #0f172a;
Â  Â  Â  --card-bg: #ffffff;
Â  Â  Â  --danger-color: #ef4444;
Â  Â  Â  --success-bg: #dcfce7;
Â  Â  Â  --success-text: #166534;
Â  Â  Â  --import-color: #059669;
Â  Â  }
Â  Â  * { box-sizing: border-box; touch-action: manipulation; }
Â  Â  body {
Â  Â  Â  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â "Helvetica Neue", Arial, sans-serif;
Â  Â  Â  background-color: var(--bg-color);
Â  Â  Â  color: var(--text-color);
Â  Â  Â  margin: 0;
Â  Â  Â  padding: 0 0 80px;
Â  Â  Â  font-size: 16px;
Â  Â  }
Â  Â  header {
Â  Â  Â  background: linear-gradient(135deg, #0f766e, #14b8a6);
Â  Â  Â  color: #fff;
Â  Â  Â  padding: 1rem;
Â  Â  Â  text-align: center;
Â  Â  Â  position: sticky;
Â  Â  Â  top: 0;
Â  Â  Â  z-index: 100;
Â  Â  Â  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  justify-content: center;
Â  Â  }
Â  Â  header h1 { margin: 0; font-size: 1.1rem; }
Â  Â  #sound-toggle {
Â  Â  Â  position: absolute;
Â  Â  Â  right: 15px;
Â  Â  Â  background: none;
Â  Â  Â  border: none;
Â  Â  Â  color: #fff;
Â  Â  Â  font-size: 1.5rem;
Â  Â  Â  cursor: pointer;
Â  Â  Â  padding: 5px;
Â  Â  Â  opacity: 0.85;
Â  Â  }
Â  Â  #sound-toggle.muted {
Â  Â  Â  opacity: 0.5;
Â  Â  Â  text-decoration: line-through;
Â  Â  }
Â  Â  .container {
Â  Â  Â  max-width: 620px;
Â  Â  Â  margin: 0 auto;
Â  Â  Â  padding: 1rem;
Â  Â  }
Â  Â  .tabs {
Â  Â  Â  display: flex;
Â  Â  Â  background: #fff;
Â  Â  Â  padding: 0.4rem;
Â  Â  Â  border-radius: 10px;
Â  Â  Â  margin-bottom: 1rem;
Â  Â  Â  box-shadow: 0 1px 2px rgba(0,0,0,0.05);
Â  Â  }
Â  Â  .tab-btn {
Â  Â  Â  flex: 1;
Â  Â  Â  padding: 0.6rem;
Â  Â  Â  border: none;
Â  Â  Â  background: none;
Â  Â  Â  font-weight: 600;
Â  Â  Â  color: #64748b;
Â  Â  Â  cursor: pointer;
Â  Â  Â  border-bottom: 3px solid transparent;
Â  Â  Â  border-radius: 6px 6px 0 0;
Â  Â  Â  font-size: 0.9rem;
Â  Â  }
Â  Â  .tab-btn.active {
Â  Â  Â  color: #0f766e;
Â  Â  Â  border-bottom-color: #0f766e;
Â  Â  }
Â  Â  .form-group { margin-bottom: 0.9rem; }
Â  Â  label {
Â  Â  Â  display: block;
Â  Â  Â  margin-bottom: 0.3rem;
Â  Â  Â  font-weight: 600;
Â  Â  Â  color: #1e293b;
Â  Â  Â  font-size: 0.9rem;
Â  Â  }
Â  Â  input, textarea {
Â  Â  Â  width: 100%;
Â  Â  Â  padding: 0.7rem;
Â  Â  Â  border: 1px solid #cbd5f5;
Â  Â  Â  border-radius: 6px;
Â  Â  Â  font-size: 1rem;
Â  Â  Â  background: #fff;
Â  Â  Â  -webkit-appearance: none;
Â  Â  Â  appearance: none;
Â  Â  }
Â  Â  input[type="file"] {
Â  Â  Â  padding: 0.4rem;
Â  Â  Â  font-size: 0.9rem;
Â  Â  Â  background: #f9fafb;
Â  Â  }
Â  Â  input:focus, textarea:focus {
Â  Â  Â  outline: none;
Â  Â  Â  border-color: #14b8a6;
Â  Â  Â  box-shadow: 0 0 0 3px rgba(45,212,191,0.25);
Â  Â  }
Â  Â  .btn {
Â  Â  Â  border: none;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  font-weight: 600;
Â  Â  Â  display: inline-flex;
Â  Â  Â  align-items: center;
Â  Â  Â  justify-content: center;
Â  Â  Â  gap: 0.4rem;
Â  Â  Â  transition: filter 0.15s;
Â  Â  }
Â  Â  .btn:active { filter: brightness(0.95); }
Â  Â  .btn-main {
Â  Â  Â  width: 100%;
Â  Â  Â  padding: 0.9rem;
Â  Â  Â  font-size: 1rem;
Â  Â  Â  background: #0f766e;
Â  Â  Â  color: #fff;
Â  Â  Â  margin-top: 0.3rem;
Â  Â  }
Â  Â  .btn-danger {
Â  Â  Â  padding: 0.35rem 0.6rem;
Â  Â  Â  font-size: 0.8rem;
Â  Â  Â  background: var(--danger-color);
Â  Â  Â  color: #fff;
Â  Â  }
Â  Â  .btn-small {
Â  Â  Â  padding: 0.35rem 0.6rem;
Â  Â  Â  font-size: 0.8rem;
Â  Â  Â  background: #64748b;
Â  Â  Â  color: #fff;
Â  Â  }
Â  Â  .btn-export {
Â  Â  Â  width: 100%;
Â  Â  Â  padding: 0.8rem;
Â  Â  Â  margin-top: 0.5rem;
Â  Â  Â  background: #10b981;
Â  Â  Â  color: #fff;
Â  Â  Â  font-size: 0.95rem;
Â  Â  }
Â  Â  .btn-import {
Â  Â  Â  width: 100%;
Â  Â  Â  padding: 0.7rem;
Â  Â  Â  margin-top: 0.4rem;
Â  Â  Â  background: var(--import-color);
Â  Â  Â  color: #fff;
Â  Â  Â  font-size: 0.9rem;
Â  Â  }
Â  Â  .btn-toggle-import {
Â  Â  Â  width: 100%;
Â  Â  Â  padding: 0.7rem;
Â  Â  Â  margin-bottom: 0.6rem;
Â  Â  Â  background: #64748b;
Â  Â  Â  color: #fff;
Â  Â  Â  font-size: 0.9rem;
Â  Â  }
Â  Â  .btn-full-danger {
Â  Â  Â  width: 100%;
Â  Â  Â  padding: 0.7rem;
Â  Â  Â  margin-top: 0.5rem;
Â  Â  Â  background: var(--danger-color);
Â  Â  Â  color: #fff;
Â  Â  Â  font-size: 0.9rem;
Â  Â  }
Â  Â  #fuel-preview-card {
Â  Â  Â  background: var(--success-bg);
Â  Â  Â  color: var(--success-text);
Â  Â  Â  padding: 0.8rem 1rem;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  margin-bottom: 1rem;
Â  Â  Â  border: 1px solid #86efac;
Â  Â  Â  font-size: 0.9rem;
Â  Â  Â  display: none;
Â  Â  }
Â  Â  #fuel-preview-card.visible { display: block; }
Â  Â  .preview-value {
Â  Â  Â  font-size: 1.5rem;
Â  Â  Â  font-weight: 700;
Â  Â  Â  color: #14532d;
Â  Â  }
Â  Â  .preview-sub {
Â  Â  Â  font-size: 0.8rem;
Â  Â  Â  margin-top: 0.2rem;
Â  Â  }
Â  Â  .log-card {
Â  Â  Â  background: var(--card-bg);
Â  Â  Â  border-radius: 8px;
Â  Â  Â  padding: 0.9rem;
Â  Â  Â  margin-bottom: 0.9rem;
Â  Â  Â  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
Â  Â  Â  border-left: 4px solid #14b8a6;
Â  Â  }
Â  Â  .log-header {
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: space-between;
Â  Â  Â  align-items: center;
Â  Â  Â  margin-bottom: 0.4rem;
Â  Â  Â  padding-bottom: 0.3rem;
Â  Â  Â  border-bottom: 1px solid #e5e7eb;
Â  Â  }
Â  Â  .log-date {
Â  Â  Â  font-weight: 600;
Â  Â  Â  font-size: 0.95rem;
Â  Â  Â  color: #1f2937;
Â  Â  }
Â  Â  .log-actions {
Â  Â  Â  display: flex;
Â  Â  Â  gap: 0.3rem;
Â  Â  }
Â  Â  .log-main-row {
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: space-between;
Â  Â  Â  align-items: flex-end;
Â  Â  Â  margin-bottom: 0.4rem;
Â  Â  }
Â  Â  .log-km {
Â  Â  Â  font-size: 1.2rem;
Â  Â  Â  font-weight: 700;
Â  Â  Â  color: #0f766e;
Â  Â  }
Â  Â  .log-details {
Â  Â  Â  display: grid;
Â  Â  Â  grid-template-columns: 1fr 1fr;
Â  Â  Â  gap: 0.3rem 0.6rem;
Â  Â  Â  font-size: 0.85rem;
Â  Â  Â  color: #334155;
Â  Â  }
Â  Â  .log-stat-item span {
Â  Â  Â  display: block;
Â  Â  Â  font-size: 0.75rem;
Â  Â  Â  color: #6b7280;
Â  Â  }
Â  Â  .log-footer {
Â  Â  Â  margin-top: 0.4rem;
Â  Â  Â  font-size: 0.8rem;
Â  Â  Â  background: #f1f5f9;
Â  Â  Â  padding: 0.3rem 0.4rem;
Â  Â  Â  border-radius: 4px;
Â  Â  }
Â  Â  .fuel-badge {
Â  Â  Â  display: inline-block;
Â  Â  Â  background: #ccfbf1;
Â  Â  Â  color: #0f766e;
Â  Â  Â  padding: 0.15rem 0.5rem;
Â  Â  Â  border-radius: 9999px;
Â  Â  Â  font-size: 0.8rem;
Â  Â  Â  font-weight: 600;
Â  Â  }
Â  Â  .summary-card {
Â  Â  Â  background: #0f766e;
Â  Â  Â  color: #fff;
Â  Â  Â  border-radius: 10px;
Â  Â  Â  padding: 1.1rem 1rem 1rem;
Â  Â  Â  text-align: center;
Â  Â  Â  margin-bottom: 0.7rem;
Â  Â  }
Â  Â  .summary-main {
Â  Â  Â  font-size: 2rem;
Â  Â  Â  font-weight: 700;
Â  Â  Â  margin: 0.3rem 0;
Â  Â  }
Â  Â  .summary-sub {
Â  Â  Â  font-size: 0.9rem;
Â  Â  Â  opacity: 0.9;
Â  Â  }
Â  Â  .summary-grid {
Â  Â  Â  display: grid;
Â  Â  Â  grid-template-columns: 1fr 1fr;
Â  Â  Â  gap: 0.6rem;
Â  Â  Â  margin-top: 0.7rem;
Â  Â  }
Â  Â  .summary-box {
Â  Â  Â  background: rgba(255,255,255,0.12);
Â  Â  Â  padding: 0.7rem;
Â  Â  Â  border-radius: 6px;
Â  Â  Â  font-size: 0.85rem;
Â  Â  }
Â  Â  .import-section {
Â  Â  Â  margin-top: 0.5rem;
Â  Â  Â  padding: 0.7rem;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  border: 2px dashed #cbd5f5;
Â  Â  Â  background: #f8fafc;
Â  Â  Â  font-size: 0.8rem;
Â  Â  }
Â  Â  #notification {
Â  Â  Â  position: fixed;
Â  Â  Â  bottom: 20px;
Â  Â  Â  left: 50%;
Â  Â  Â  transform: translateX(-50%);
Â  Â  Â  background: #0f172a;
Â  Â  Â  color: #f9fafb;
Â  Â  Â  padding: 0.5rem 1rem;
Â  Â  Â  border-radius: 9999px;
Â  Â  Â  font-size: 0.8rem;
Â  Â  Â  display: none;
Â  Â  Â  z-index: 1000;
Â  Â  Â  box-shadow: 0 8px 20px rgba(0,0,0,0.4);
Â  Â  Â  white-space: nowrap;
Â  Â  }
Â  Â  .hidden { display: none; }
Â  Â  small.hint { font-size: 0.75rem; color: #64748b; }
Â  </style>
</head>
<body>
<header>
Â  <h1>ğŸ›µ ã‚¹ãƒ¼ãƒ‘ãƒ¼ã‚«ãƒ–ç‡ƒè²»è¨˜éŒ²</h1>
Â  <button id="sound-toggle" onclick="toggleSound()">ğŸ”Š</button>
</header>

<div class="container">
Â  <div class="tabs">
Â  Â  <button class="tab-btn active" onclick="switchTab('input')">å…¥åŠ›</button>
Â  Â  <button class="tab-btn" onclick="switchTab('list')">å±¥æ­´</button>
Â  Â  <button class="tab-btn" onclick="switchTab('summary')">æœˆæ¬¡é›†è¨ˆ</button>
Â  </div>

Â  Â  <div id="view-input" class="tab-content">
Â  Â  <div id="fuel-preview-card">
Â  Â  Â  <div>ä»Šå›ã®è¨ˆç®—çµæœï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰</div>
Â  Â  Â  <div class="preview-value" id="preview-efficiency">-</div>
Â  Â  Â  <div class="preview-sub">
Â  Â  Â  Â  èµ°è¡Œ: <span id="preview-distance">0</span> km /
Â  Â  Â  Â  çµ¦æ²¹: <span id="preview-fuel">0</span> L
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="log-card" style="border-left-color: var(--accent-color);">
Â  Â  Â  <form id="fuelForm">
Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  <label for="date">æ—¥ä»˜</label>
Â  Â  Â  Â  Â  <input type="date" id="date" required>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  <label for="odometer">ã‚ªãƒ‰ãƒ¡ãƒ¼ã‚¿ãƒ¼ (km)</label>
Â  Â  Â  Â  Â  <input type="number" id="odometer"
Â  Â  Â  Â  Â  Â  Â  Â  Â placeholder="ä¾‹: 56061.8" step="0.1" inputmode="decimal" required>
Â  Â  Â  Â  Â  <small id="last-odometer-hint" class="hint"></small>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  <label for="fuel">çµ¦æ²¹é‡ (L)</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="fuel"
Â  Â  Â  Â  Â  Â  Â  Â  Â inputmode="decimal"
Â  Â  Â  Â  Â  Â  Â  Â  Â pattern="^[0-9ï¼-ï¼™.,ï¼]*$"
Â  Â  Â  Â  Â  Â  Â  Â  Â placeholder="ä¾‹: 3.65">
Â  Â  Â  Â  Â  <small class="hint">å°æ•°ç¬¬2ä½ã¾ã§å…¥åŠ›å¯ï¼ˆä¾‹: 3.65 / ï¼“ï¼ï¼–ï¼•ï¼‰</small>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  <label for="memo">ãƒ¡ãƒ¢</label>
Â  Â  Â  Â  Â  <textarea id="memo" rows="2"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  placeholder="çµ¦æ²¹å ´æ‰€ã‚„èµ°è¡Œæ¡ä»¶ãªã©"></textarea>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <button type="submit" class="btn btn-main" id="submitButton">
Â  Â  Â  Â  Â  ğŸ’¾ è¨˜éŒ²ã‚’è¿½åŠ ã™ã‚‹
Â  Â  Â  Â  </button>
Â  Â  Â  </form>
Â  Â  </div>
Â  </div>

Â  Â  <div id="view-list" class="hidden tab-content">
Â  Â  <button class="btn btn-toggle-import" onclick="toggleImportPanel()">
Â  Â  Â  ğŸ“¥ CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã‚’é–‹ã
Â  Â  </button>

Â  Â  <div id="import-panel" class="import-section hidden">
Â  Â  Â  <div style="color:var(--import-color); font-weight:600; margin-bottom:0.3rem;">
Â  Â  Â  Â  ğŸ›µ CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼è‡ªå‹•åˆ¤å®šï¼‰
Â  Â  Â  </div>
Â  Â  Â  <div>â€»1è¡Œç›®ã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ã¨ã—ã¦ã€æ—¥ä»˜ãƒ»ã‚ªãƒ‰ãƒ»çµ¦æ²¹é‡ã®åˆ—ã‚’è‡ªå‹•ã§æ¢ã—ã¾ã™ã€‚</div>
Â  Â  Â  <input type="file" id="csvFile" accept=".csv">
Â  Â  Â  <button class="btn btn-import" onclick="importCSV()">ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ</button>
Â  Â  Â  <div style="margin-top:0.3rem; color:#64748b;">
Â  Â  Â  Â  åƒåŒºåˆ‡ã‚Šä»˜ãæ•°å€¤ï¼ˆä¾‹: 56,061.80ï¼‰ã«ã‚‚å¯¾å¿œã—ã¾ã™ã€‚
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="logs-container">
Â  Â  Â  <p style="text-align:center; color:#888; padding:1.5rem 0;">
Â  Â  Â  Â  ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­â€¦
Â  Â  Â  </p>
Â  Â  Â  
Â  Â  </div>

Â  Â  <button class="btn btn-export" onclick="exportCSV()">ğŸ“¤ CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
Â  Â  <button class="btn btn-full-danger" onclick="deleteAllLogs()">
Â  Â  Â  ğŸ—‘ï¸ å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
Â  Â  </button>
Â  </div>

Â  Â  <div id="view-summary" class="hidden tab-content">
Â  Â  <div class="form-group">
Â  Â  Â  <label for="summaryMonth">è¡¨ç¤ºå¹´æœˆ</label>
Â  Â  Â  <input type="month" id="summaryMonth" onchange="renderSummary()">
Â  Â  </div>
Â  Â  <div id="summary-content">
Â  Â  Â  <p style="text-align:center; color:#888; padding:2rem 0;">
Â  Â  Â  Â  å¹´æœˆã‚’é¸ã‚“ã§é›†è¨ˆã—ã¦ãã ã•ã„ã€‚
Â  Â  Â  </p>
Â  Â  </div>
Â  </div>
</div>

<div id="notification">ä¿å­˜ã—ã¾ã—ãŸ</div>

<script>
Â  const DB_NAME = 'CubFuelDB';
Â  const DB_VERSION = 2;
Â  const STORE_NAME = 'logs';
Â  let db;
Â  let allLogs = [];
Â  let editingId = null;

Â  let isSoundOn = localStorage.getItem('cubAppSound') !== 'off';
Â  let audioCtx = null;

Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  document.getElementById('date').valueAsDate = new Date();
Â  Â  document.getElementById('summaryMonth').value =
Â  Â  Â  new Date().toISOString().slice(0, 7);
Â  Â  initDB();
Â  Â  updateSoundButton();

Â  Â  ['odometer', 'fuel'].forEach(id => {
Â  Â  Â  document.getElementById(id).addEventListener('input', updatePreview);
Â  Â  });

Â  Â  document.getElementById('fuelForm')
Â  Â  Â  .addEventListener('submit', handleSubmit);

Â  Â  if ('serviceWorker' in navigator &&
Â  Â  Â  Â  (location.protocol === 'http:' || location.protocol === 'https:')) {
Â  Â  Â  navigator.serviceWorker.register('./sw.js').catch(console.error);
Â  Â  }
Â  });

Â  function toggleSound() {
Â  Â  isSoundOn = !isSoundOn;
Â  Â  localStorage.setItem('cubAppSound', isSoundOn ? 'on' : 'off');
Â  Â  updateSoundButton();
Â  Â  if (isSoundOn) playHorn();
Â  }
Â  function updateSoundButton() {
Â  Â  const btn = document.getElementById('sound-toggle');
Â  Â  if (isSoundOn) {
Â  Â  Â  btn.textContent = 'ğŸ”Š';
Â  Â  Â  btn.classList.remove('muted');
Â  Â  } else {
Â  Â  Â  btn.textContent = 'ğŸ”‡';
Â  Â  Â  btn.classList.add('muted');
Â  Â  }
Â  }
Â  function playHorn() {
Â  Â  if (!isSoundOn) return;
Â  Â  if (!audioCtx) {
Â  Â  Â  const AC = window.AudioContext || window.webkitAudioContext;
Â  Â  Â  audioCtx = new AC();
Â  Â  }
Â  Â  if (audioCtx.state === 'suspended') audioCtx.resume();
Â  Â  const now = audioCtx.currentTime;
Â  Â  const osc = audioCtx.createOscillator();
Â  Â  const gain = audioCtx.createGain();
Â  Â  osc.type = 'triangle';
Â  Â  osc.frequency.setValueAtTime(660, now);
Â  Â  gain.gain.setValueAtTime(0, now);
Â  Â  gain.gain.linearRampToValueAtTime(0.4, now + 0.03);
Â  Â  gain.gain.exponentialRampToValueAtTime(0.01, now + 0.25);
Â  Â  osc.connect(gain);
Â  Â  gain.connect(audioCtx.destination);
Â  Â  osc.start(now);
Â  Â  osc.stop(now + 0.25);
Â  }

Â  function initDB() {
Â  Â  const req = indexedDB.open(DB_NAME, DB_VERSION);
Â  Â  req.onupgradeneeded = e => {
Â  Â  Â  db = e.target.result;
Â  Â  Â  if (!db.objectStoreNames.contains(STORE_NAME)) {
Â  Â  Â  Â  const store = db.createObjectStore(STORE_NAME,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { keyPath: 'id', autoIncrement: true });
Â  Â  Â  Â  store.createIndex('date', 'date');
Â  Â  Â  }
Â  Â  };
Â  Â  req.onsuccess = e => { db = e.target.result; loadLogs(); };
Â  Â  req.onerror = e => {
Â  Â  Â  console.error(e);
Â  Â  Â  showNotification('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒé–‹ã‘ã¾ã›ã‚“ã€‚');
Â  Â  };
Â  }

Â  function handleSubmit(e) {
Â  Â  e.preventDefault();
Â  Â  const fuelVal = document.getElementById('fuel').value;
Â  Â  const fuelNum = parseFuelInput(fuelVal);
Â  Â  const odoNum = parseFloat(
Â  Â  Â  toHalfWidth(document.getElementById('odometer').value)
Â  Â  );

Â  Â  if (!document.getElementById('date').value || isNaN(odoNum)) {
Â  Â  Â  showNotification('æ—¥ä»˜ã¨ã‚ªãƒ‰ãƒ¡ãƒ¼ã‚¿ãƒ¼ã¯å¿…é ˆã§ã™ã€‚');
Â  Â  Â  return;
Â  Â  }
Â  Â  if (fuelVal.trim() && isNaN(fuelNum)) {
Â  Â  Â  showNotification('çµ¦æ²¹é‡ãŒæ•°å€¤ã¨ã—ã¦èª­ã¿å–ã‚Œã¾ã›ã‚“ã€‚');
Â  Â  Â  return;
Â  Â  }

Â  Â  const data = {
Â  Â  Â  date: document.getElementById('date').value,
Â  Â  Â  odometer: odoNum,
Â  Â  Â  fuel: isNaN(fuelNum) ? 0 : fuelNum,
Â  Â  Â  memo: document.getElementById('memo').value,
Â  Â  Â  timestamp: Date.now()
Â  Â  };

Â  Â  if (editingId !== null) {
Â  Â  Â  updateLog(editingId, data);
Â  Â  } else {
Â  Â  Â  addLog(data);
Â  Â  }
Â  }

Â  function addLog(data) {
Â  Â  if (!db) return;
Â  Â  const tx = db.transaction([STORE_NAME], 'readwrite');
Â  Â  tx.objectStore(STORE_NAME).add(data);
Â  Â  tx.oncomplete = () => {
Â  Â  Â  playHorn();
Â  Â  Â  resetForm();
Â  Â  Â  loadLogs();
Â  Â  Â  showNotification('è¨˜éŒ²ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚');
Â  Â  };
Â  Â  tx.onerror = () => showNotification('è¨˜éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
Â  }

Â  function updateLog(id, data) {
Â  Â  if (!db) return;
Â  Â  const tx = db.transaction([STORE_NAME], 'readwrite');
Â  Â  const store = tx.objectStore(STORE_NAME);
Â  Â  const req = store.get(id);
Â  Â  req.onsuccess = () => {
Â  Â  Â  const old = req.result;
Â  Â  Â  if (!old) { addLog(data); return; }
Â  Â  Â  const updated = { ...old, ...data, id };
Â  Â  Â  store.put(updated);
Â  Â  };
Â  Â  tx.oncomplete = () => {
Â  Â  Â  playHorn();
Â  Â  Â  resetForm();
Â  Â  Â  loadLogs();
Â  Â  Â  showNotification('è¨˜éŒ²ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚');
Â  Â  };
Â  Â  tx.onerror = () => showNotification('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
Â  }

Â  function resetForm() {
Â  Â  editingId = null;
Â  Â  document.getElementById('fuelForm').reset();
Â  Â  document.getElementById('date').valueAsDate = new Date();
Â  Â  document.getElementById('submitButton').textContent = 'ğŸ’¾ è¨˜éŒ²ã‚’è¿½åŠ ã™ã‚‹';
Â  Â  document.getElementById('fuel-preview-card').classList.remove('visible');
Â  }

Â  function loadLogs() {
Â  Â  if (!db) return;
Â  Â  const tx = db.transaction([STORE_NAME], 'readonly');
Â  Â  tx.objectStore(STORE_NAME).getAll().onsuccess = e => {
Â  Â  Â  const raw = e.target.result || [];
Â  Â  Â  raw.sort((a, b) => {
Â  Â  Â  Â  if (a.date === b.date) return (a.odometer || 0) - (b.odometer || 0);
Â  Â  Â  Â  return a.date < b.date ? -1 : 1;
Â  Â  Â  });
Â  Â  Â  let prev = null;
Â  Â  Â  allLogs = raw.map((log, idx) => {
Â  Â  Â  Â  let distance = 0;
Â  Â  Â  Â  let isFirst = false;
Â  Â  Â  Â  if (idx === 0) {
Â  Â  Â  Â  Â  isFirst = true;
Â  Â  Â  Â  } else if (prev && typeof prev.odometer === 'number') {
Â  Â  Â  Â  Â  const d = (log.odometer || 0) - (prev.odometer || 0);
Â  Â  Â  Â  Â  if (d > 0) distance = d;
Â  Â  Â  Â  Â  else isFirst = true;
Â  Â  Â  Â  }
Â  Â  Â  Â  const f = typeof log.fuel === 'number'
Â  Â  Â  Â  Â  ? Math.round(log.fuel * 100) / 100
Â  Â  Â  Â  Â  : 0;
Â  Â  Â  Â  const totalFuel = f;
Â  Â  Â  Â  const efficiency =
Â  Â  Â  Â  Â  distance > 0 && totalFuel > 0 ? distance / totalFuel : 0;
Â  Â  Â  Â  const enriched = {
Â  Â  Â  Â  Â  ...log,
Â  Â  Â  Â  Â  fuel: f,
Â  Â  Â  Â  Â  distance,
Â  Â  Â  Â  Â  totalFuel,
Â  Â  Â  Â  Â  efficiency,
Â  Â  Â  Â  Â  isFirst
Â  Â  Â  Â  };
Â  Â  Â  Â  prev = enriched;
Â  Â  Â  Â  return enriched;
Â  Â  Â  });

Â  Â  Â  if (allLogs.length > 0) {
Â  Â  Â  Â  const last = allLogs[allLogs.length - 1];
Â  Â  Â  Â  document.getElementById('last-odometer-hint').textContent =
Â  Â  Â  Â  Â  `æœ€æ–°ã®è¨˜éŒ²: ${last.date} / ${formatNumber(last.odometer)} km`;
Â  Â  Â  } else {
Â  Â  Â  Â  document.getElementById('last-odometer-hint').textContent =
Â  Â  Â  Â  Â  'ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
Â  Â  Â  }

Â  Â  Â  renderList();
Â  Â  Â  renderSummary();
Â  Â  Â  updatePreview();
Â  Â  };
Â  }

Â  function updatePreview() {
Â  Â  const card = document.getElementById('fuel-preview-card');
Â  Â  if (allLogs.length === 0) {
Â  Â  Â  card.classList.remove('visible');
Â  Â  Â  return;
Â  Â  }
Â  Â  const odo = parseFloat(
Â  Â  Â  toHalfWidth(document.getElementById('odometer').value)
Â  Â  );
Â  Â  const fuelVal = document.getElementById('fuel').value;
Â  Â  const fuel = parseFuelInput(fuelVal);

Â  Â  if (!odo || isNaN(fuel) || fuel <= 0) {
Â  Â  Â  card.classList.remove('visible');
Â  Â  Â  return;
Â  Â  }

Â  Â  const temp = [...allLogs, {
Â  Â  Â  id: -1,
Â  Â  Â  date: document.getElementById('date').value || '',
Â  Â  Â  odometer: odo,
Â  Â  Â  fuel
Â  Â  }];
Â  Â  temp.sort((a, b) => {
Â  Â  Â  if (a.date === b.date) return (a.odometer || 0) - (b.odometer || 0);
Â  Â  Â  return a.date < b.date ? -1 : 1;
Â  Â  });
Â  Â  const idx = temp.findIndex(l => l.id === -1);
Â  Â  if (idx <= 0) {
Â  Â  Â  card.classList.remove('visible');
Â  Â  Â  return;
Â  Â  }
Â  Â  const prev = temp[idx - 1];
Â  Â  const dist = odo - (prev.odometer || 0);
Â  Â  if (dist <= 0) {
Â  Â  Â  card.classList.remove('visible');
Â  Â  Â  return;
Â  Â  }
Â  Â  document.getElementById('preview-distance').textContent =
Â  Â  Â  formatNumber(dist);
Â  Â  document.getElementById('preview-fuel').textContent =
Â  Â  Â  fuel.toFixed(2);
Â  Â  document.getElementById('preview-efficiency').textContent =
Â  Â  Â  (dist / fuel).toFixed(2) + ' km/L';
Â  Â  card.classList.add('visible');
Â  }

Â  function renderList() {
Â  Â  const container = document.getElementById('logs-container');
Â  Â  container.innerHTML = '';
Â  Â  if (allLogs.length === 0) {
Â  Â  Â  container.innerHTML =
Â  Â  Â  Â  '<p style="text-align:center; padding:2rem 0; color:#888;">ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
Â  Â  Â  return;
Â  Â  }
Â  Â  [...allLogs].slice().reverse().forEach(log => {
Â  Â  Â  const dateStr = log.date || '';
Â  Â  Â  const fuelText = log.totalFuel > 0 ? log.totalFuel.toFixed(2) : '-';
Â  Â  Â  const effText = log.isFirst || log.efficiency <= 0
Â  Â  Â  Â  ? '-'
Â  Â  Â  Â  : log.efficiency.toFixed(2);
Â  Â  Â  const distText = log.isFirst || log.distance <= 0
Â  Â  Â  Â  ? '(åˆå›)'
Â  Â  Â  Â  : '+' + formatNumber(log.distance) + ' km';
Â  Â  Â  const memoText = [log.isAggregated ? 'âš ï¸ åˆç®—ã‚ã‚Š' : '', log.memo || '']
Â  Â  Â  Â  .join(' ').trim();
Â  Â  Â  container.insertAdjacentHTML('beforeend', `
Â  Â  Â  Â  <div class="log-card">
Â  Â  Â  Â  Â  <div class="log-header">
Â  Â  Â  Â  Â  Â  <span class="log-date">${escapeHtml(dateStr)}</span>
Â  Â  Â  Â  Â  Â  <div class="log-actions">
Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-small" onclick="editLog(${log.id})">
Â  Â  Â  Â  Â  Â  Â  Â  ç·¨é›†
Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-danger" onclick="deleteLog(${log.id})">
Â  Â  Â  Â  Â  Â  Â  Â  å‰Šé™¤
Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="log-main-row">
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  <span style="font-size:0.8rem; color:#6b7280;">ä»Šå›ç‡ƒè²»</span><br>
Â  Â  Â  Â  Â  Â  Â  <span class="log-km">${effText}</span>
Â  Â  Â  Â  Â  Â  Â  <span style="font-size:0.85rem;">km/L</span>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div style="text-align:right;">
Â  Â  Â  Â  Â  Â  Â  <span style="font-size:0.8rem; color:#6b7280;">èµ°è¡Œè·é›¢</span><br>
Â  Â  Â  Â  Â  Â  Â  <span style="font-weight:600;">${distText}</span>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="log-details">
Â  Â  Â  Â  Â  Â  <div class="log-stat-item">
Â  Â  Â  Â  Â  Â  Â  <span>ã‚ªãƒ‰ãƒ¡ãƒ¼ã‚¿ãƒ¼</span>
Â  Â  Â  Â  Â  Â  Â  ${formatNumber(log.odometer)} km
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="log-stat-item">
Â  Â  Â  Â  Â  Â  Â  <span>çµ¦æ²¹é‡</span>
Â  Â  Â  Â  Â  Â  Â  <span class="fuel-badge">${fuelText} L</span>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  ${memoText ? `<div class="log-footer">${escapeHtml(memoText)}</div>` : ''}
Â  Â  Â  Â  </div>
Â  Â  Â  `);
Â  Â  });
Â  }

Â  function editLog(id) {
Â  Â  const log = allLogs.find(l => l.id === id);
Â  Â  if (!log) return;
Â  Â  editingId = id;
Â  Â  document.getElementById('date').value = log.date;
Â  Â  document.getElementById('odometer').value = log.odometer;
Â  Â  const f = log.fuel ?? log.totalFuel;
Â  Â  document.getElementById('fuel').value =
Â  Â  Â  typeof f === 'number' && !isNaN(f) && f > 0
Â  Â  Â  Â  ? (Math.round(f * 100) / 100).toFixed(2)
Â  Â  Â  Â  : '';
Â  Â  document.getElementById('memo').value = log.memo || '';
Â  Â  document.getElementById('submitButton').textContent = 'âœï¸ è¨˜éŒ²ã‚’æ›´æ–°ã™ã‚‹';
Â  Â  switchTab('input');
Â  Â  updatePreview();
Â  }

Â  function deleteLog(id) {
Â  Â  if (!db) return;
Â  Â  if (!confirm('ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
Â  Â  const tx = db.transaction([STORE_NAME], 'readwrite');
Â  Â  tx.objectStore(STORE_NAME).delete(id);
Â  Â  tx.oncomplete = () => {
Â  Â  Â  showNotification('å‰Šé™¤ã—ã¾ã—ãŸã€‚');
Â  Â  Â  loadLogs();
Â  Â  };
Â  }

Â  function deleteAllLogs() {
Â  Â  if (!db) return;
Â  Â  if (!confirm('æœ¬å½“ã«å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
Â  Â  const tx = db.transaction([STORE_NAME], 'readwrite');
Â  Â  tx.objectStore(STORE_NAME).clear();
Â  Â  tx.oncomplete = () => {
Â  Â  Â  allLogs = [];
Â  Â  Â  renderList();
Â  Â  Â  renderSummary();
Â  Â  Â  showNotification('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚');
Â  Â  };
Â  }

Â  function renderSummary() {
Â  Â  const month = document.getElementById('summaryMonth').value;
Â  Â  const container = document.getElementById('summary-content');
Â  Â  if (!month) return;
Â  Â  const monthly = allLogs.filter(l => (l.date || '').startsWith(month));
Â  Â  if (monthly.length === 0) {
Â  Â  Â  container.innerHTML =
Â  Â  Â  Â  '<p style="text-align:center; padding:2rem 0; color:#888;">ãƒ‡ãƒ¼ã‚¿ãªã—</p>';
Â  Â  Â  return;
Â  Â  }
Â  Â  let dist = 0;
Â  Â  let fuel = 0;
Â  Â  monthly.forEach(l => {
Â  Â  Â  if (!l.isFirst && l.distance > 0 && l.totalFuel > 0) {
Â  Â  Â  Â  dist += l.distance;
Â  Â  Â  Â  fuel += l.totalFuel;
Â  Â  Â  }
Â  Â  });
Â  Â  const avg = dist > 0 && fuel > 0 ? (dist / fuel).toFixed(2) : '-';
Â  Â  container.innerHTML = `
Â  Â  Â  <div class="summary-card">
Â  Â  Â  Â  <div>æœˆå¹³å‡ç‡ƒè²»</div>
Â  Â  Â  Â  <div class="summary-main">
Â  Â  Â  Â  Â  ${avg} <span style="font-size:0.9rem;">km/L</span>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="summary-sub">${month}</div>
Â  Â  Â  Â  <div class="summary-grid">
Â  Â  Â  Â  Â  <div class="summary-box">
Â  Â  Â  Â  Â  Â  <div>ç·èµ°è¡Œè·é›¢</div>
Â  Â  Â  Â  Â  Â  <div style="font-weight:600; font-size:1.1rem;">
Â  Â  Â  Â  Â  Â  Â  ${formatNumber(dist)} km
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="summary-box">
Â  Â  Â  Â  Â  Â  <div>ç·çµ¦æ²¹é‡</div>
Â  Â  Â  Â  Â  Â  <div style="font-weight:600; font-size:1.1rem;">
Â  Â  Â  Â  Â  Â  Â  ${fuel.toFixed(2)} L
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  `;
Â  }

Â  function switchTab(tab) {
Â  Â  document.querySelectorAll('.tab-btn').forEach(btn => {
Â  Â  Â  btn.classList.remove('active');
Â  Â  });
Â  Â  document
Â  Â  Â  .querySelector(`.tab-btn[onclick*="${tab}"]`)
Â  Â  Â  .classList.add('active');
Â  Â  document.querySelectorAll('.tab-content').forEach(v => {
Â  Â  Â  v.classList.add('hidden');
Â  Â  });
Â  Â  document.getElementById(`view-${tab}`).classList.remove('hidden');
Â  Â  if (tab === 'list') renderList();
Â  Â  if (tab === 'summary') renderSummary();
Â  }

Â  function toggleImportPanel() {
Â  Â  const panel = document.getElementById('import-panel');
Â  Â  panel.classList.toggle('hidden');
Â  }

Â  function importCSV() {
Â  Â  const file = document.getElementById('csvFile').files[0];
Â  Â  if (!file) {
Â  Â  Â  showNotification('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚');
Â  Â  Â  return;
Â  Â  }
Â  Â  const reader = new FileReader();
Â  Â  reader.onload = e => parseAndImport(e.target.result);
Â  Â  reader.readAsText(file, 'UTF-8');
Â  }

Â  function parseAndImport(csv) {
Â  Â  if (!db) return;
Â  Â  const lines = csv.split(/\r?\n/).map(l => l.trim()).filter(l => l);
Â  Â  if (lines.length <= 1) {
Â  Â  Â  showNotification('æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
Â  Â  Â  return;
Â  Â  }

Â  Â  const header = lines[0].split(',').map(cleanCell);
Â  Â  let dateIdx = 0, odoIdx = 1, fuelIdx = 2, memoIdx = -1;

Â  Â  header.forEach((name, i) => {
Â  Â  Â  if (/(æ—¥ä»˜|date)/i.test(name)) dateIdx = i;
Â  Â  Â  if (/(ã‚ªãƒ‰|è·é›¢|ãƒ¡ãƒ¼ã‚¿|ç©ç®—)/.test(name)) odoIdx = i;
Â  Â  Â  if (/(çµ¦æ²¹|ç‡ƒæ–™|åˆè¨ˆç‡ƒæ–™|L)/i.test(name)) fuelIdx = i;
Â  Â  Â  if (/(ãƒ¡ãƒ¢|å‚™è€ƒ|note)/i.test(name)) memoIdx = i;
Â  Â  });

Â  Â  const records = [];
Â  Â  for (let i = 1; i < lines.length; i++) {
Â  Â  Â  const cols = lines[i].split(',').map(cleanCell);
Â  Â  Â  if (!cols[dateIdx] && !cols[odoIdx]) continue;
Â  Â  Â  const date = cols[dateIdx].replace(/\./g, '-').replace(/\//g, '-');
Â  Â  Â  const odoStr = toHalfWidth(cols[odoIdx]).replace(/,/g, '');
Â  Â  Â  const fuelStr = cols[fuelIdx] || '';
Â  Â  Â  const odo = parseFloat(odoStr);
Â  Â  Â  const fuel = parseFuelInput(fuelStr);
Â  Â  Â  if (!date || isNaN(odo) || isNaN(fuel)) continue;
Â  Â  Â  records.push({
Â  Â  Â  Â  date,
Â  Â  Â  Â  odometer: odo,
Â  Â  Â  Â  fuel,
Â  Â  Â  Â  memo: memoIdx >= 0 ? cols[memoIdx] : `CSVè¡Œ${i + 1}`,
Â  Â  Â  Â  timestamp: Date.now()
Â  Â  Â  });
Â  Â  }
Â  Â  if (records.length === 0) {
Â  Â  Â  showNotification('å–ã‚Šè¾¼ã‚ã‚‹è¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
Â  Â  Â  return;
Â  Â  }

Â  Â  const existingKey = new Set(
Â  Â  Â  allLogs.map(l => `${l.date}|${l.odometer}`)
Â  Â  );
Â  Â  const toImport = records.filter(r =>
Â  Â  Â  !existingKey.has(`${r.date}|${r.odometer}`)
Â  Â  );

Â  Â  if (toImport.length === 0) {
Â  Â  Â  showNotification('æ–°è¦ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
Â  Â  Â  return;
Â  Â  }

Â  Â  const tx = db.transaction([STORE_NAME], 'readwrite');
Â  Â  const store = tx.objectStore(STORE_NAME);
Â  Â  toImport.forEach(r => store.add(r));
Â  Â  tx.oncomplete = () => {
Â  Â  Â  showNotification(`${toImport.length}ä»¶ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚`);
Â  Â  Â  document.getElementById('csvFile').value = '';
Â  Â  Â  loadLogs();
Â  Â  };
Â  }

Â  function exportCSV() {
Â  Â  if (allLogs.length === 0) {
Â  Â  Â  showNotification('ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
Â  Â  Â  return;
Â  Â  }
Â  Â  let csv =
Â  Â  Â  'æ—¥ä»˜,ã‚ªãƒ‰ãƒ¡ãƒ¼ã‚¿ãƒ¼,èµ°è¡Œè·é›¢,çµ¦æ²¹é‡,ç‡ƒè²»,ãƒ¡ãƒ¢\n';
Â  Â  allLogs.forEach(l => {
Â  Â  Â  csv += [
Â  Â  Â  Â  l.date,
Â  Â  Â  Â  l.odometer,
Â  Â  Â  Â  l.isFirst ? 0 : l.distance,
Â  Â  Â  Â  (l.totalFuel || 0).toFixed(2),
Â  Â  Â  Â  l.isFirst ? 0 : l.efficiency.toFixed(2),
Â  Â  Â  Â  `"${(l.memo || '').replace(/"/g, '""')}"`
Â  Â  Â  ].join(',') + '\n';
Â  Â  });
Â  Â  const blob = new Blob(
Â  Â  Â  [new Uint8Array([0xEF, 0xBB, 0xBF]), csv],
Â  Â  Â  { type: 'text/csv' }
Â  Â  );
Â  Â  const url = URL.createObjectURL(blob);
Â  Â  const a = document.createElement('a');
Â  Â  a.href = url;
Â  Â  a.download = 'cub_log.csv';
Â  Â  a.click();
Â  Â  URL.revokeObjectURL(url);
Â  }

Â  function showNotification(msg) {
Â  Â  const el = document.getElementById('notification');
Â  Â  el.textContent = msg;
Â  Â  el.style.display = 'block';
Â  Â  setTimeout(() => { el.style.display = 'none'; }, 4000);
Â  }

Â  function toHalfWidth(str) {
Â  Â  return (str || '').replace(/[ï¼-ï¼™ï¼ï¼Œ]/g, ch => {
Â  Â  Â  const code = ch.charCodeAt(0);
Â  Â  Â  if (ch === 'ï¼') return '.';
Â  Â  Â  if (ch === 'ï¼Œ') return ',';
Â  Â  Â  return String.fromCharCode(code - 0xFEE0);
Â  Â  });
Â  }
Â  function cleanCell(c) {
Â  Â  return c.replace(/^"|"$/g, '').trim();
Â  }
Â  function escapeHtml(s) {
Â  Â  return (s || '').replace(/[&<>"']/g, c => ({
Â  Â  Â  '&': '&amp;', '<': '&lt;', '>': '&gt;',
Â  Â  Â  '"': '&quot;', "'": '&#039;'
Â  Â  })[c]);
Â  }
Â  function formatNumber(n) {
Â  Â  if (!n && n !== 0) return '';
Â  Â  return Number(n).toLocaleString('ja-JP', { maximumFractionDigits: 1 });
Â  }

Â  // ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰çµ¦æ²¹é‡ã‚’ãƒ‘ãƒ¼ã‚¹ã™ã‚‹ï¼ˆå¼·åˆ¶çš„ãªå°æ•°ç¬¬2ä½ã¸ã®ä¸¸ã‚ã‚’å‰Šé™¤ï¼‰
Â  function parseFuelInput(value) {
Â  Â  const s = toHalfWidth(value || '').replace(/,/g, '').trim();
Â  Â  if (!s) return NaN;
Â  Â  const num = parseFloat(s);
Â  Â  if (isNaN(num)) return NaN;
Â  Â  // return Math.round(num * 100) / 100; // å…ƒã®ã‚³ãƒ¼ãƒ‰ã®å¼·åˆ¶çš„ãªä¸¸ã‚ã‚’å‰Šé™¤
Â  Â  return num;
Â  }
</script>
</body>
</html>
