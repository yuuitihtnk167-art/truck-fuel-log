<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>トラック燃費記録</title>
  <meta name="theme-color" content="#1e3a8a">
  <meta name="description" content="大型トラック燃費管理アプリ">
  <link rel="manifest" href="truck-manifest.webmanifest">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🚛</text></svg>">
  <style>
    :root {
      --primary-color: #1e3a8a;
      --secondary-color: #3b82f6;
      --accent-color: #f59e0b;
      --bg-color: #f3f4f6;
      --text-color: #1f2937;
      --card-bg: #ffffff;
      --danger-color: #ef4444;
      --success-bg: #dcfce7;
      --success-text: #166534;
      --import-color: #059669;
    }
    * { box-sizing: border-box; touch-action: manipulation; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                   "Helvetica Neue", Arial, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      margin: 0;
      padding: 0 0 80px;
      font-size: 16px;
    }
    header {
      background-color: var(--primary-color);
      color: #fff;
      padding: 1rem;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    header h1 { margin: 0; font-size: 1.1rem; }

    .container {
      max-width: 620px;
      margin: 0 auto;
      padding: 1rem;
    }
    .tabs {
      display: flex;
      background: #fff;
      padding: 0.4rem;
      border-radius: 10px;
      margin-bottom: 1rem;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .tab-btn {
      flex: 1;
      padding: 0.6rem;
      border: none;
      background: none;
      font-weight: 600;
      color: #6b7280;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      border-radius: 6px 6px 0 0;
      font-size: 0.9rem;
    }
    .tab-btn.active {
      color: var(--primary-color);
      border-bottom-color: var(--primary-color);
    }
    .form-group { margin-bottom: 0.9rem; }
    label {
      display: block;
      margin-bottom: 0.3rem;
      font-weight: 600;
      color: #374151;
      font-size: 0.9rem;
    }
    input, textarea, select {
      width: 100%;
      padding: 0.7rem;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 1rem;
      background: #fff;
      -webkit-appearance: none;
      appearance: none;
    }
    input[type="file"] {
      padding: 0.4rem;
      font-size: 0.9rem;
      background: #f9fafb;
    }
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--secondary-color);
      box-shadow: 0 0 0 3px rgba(59,130,246,0.2);
    }
    .btn {
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
      transition: filter 0.15s;
    }
    .btn:active { filter: brightness(0.95); }
    .btn-main {
      width: 100%;
      padding: 0.9rem;
      font-size: 1rem;
      background: var(--primary-color);
      color: #fff;
      margin-top: 0.3rem;
    }
    .btn-danger {
      padding: 0.35rem 0.6rem;
      font-size: 0.8rem;
      background: var(--danger-color);
      color: #fff;
    }
    .btn-small {
      padding: 0.35rem 0.6rem;
      font-size: 0.8rem;
      background: #4b5563;
      color: #fff;
    }
    .btn-export {
      width: 100%;
      padding: 0.8rem;
      margin-top: 0.5rem;
      background: #10b981;
      color: #fff;
      font-size: 0.95rem;
    }
    .btn-import {
      width: 100%;
      padding: 0.7rem;
      margin-top: 0.4rem;
      background: var(--import-color);
      color: #fff;
      font-size: 0.9rem;
    }
    .btn-toggle-import {
      width: 100%;
      padding: 0.7rem;
      margin-bottom: 0.6rem;
      background: #6b7280;
      color: #fff;
      font-size: 0.9rem;
    }
    .btn-full-danger {
      width: 100%;
      padding: 0.7rem;
      margin-top: 0.5rem;
      background: var(--danger-color);
      color: #fff;
      font-size: 0.9rem;
    }
    .toggle-group {
      display: grid;
      gap: 0.4rem;
    }
    .toggle-group input {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }
    .toggle-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.45rem 0.5rem;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 0.85rem;
      font-weight: 600;
      color: #374151;
      background: #fff;
      cursor: pointer;
      user-select: none;
    }
    .toggle-group input:checked + .toggle-btn {
      background: var(--primary-color);
      color: #fff;
      border-color: var(--primary-color);
    }
    .action-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.6rem;
      margin-top: 0.5rem;
    }
    .action-row .btn {
      width: 100%;
      margin-top: 0;
    }
    #fuel-preview-card {
      background: var(--success-bg);
      color: var(--success-text);
      padding: 0.8rem 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      border: 1px solid #86efac;
      display: none;
      font-size: 0.9rem;
    }
    #fuel-preview-card.visible { display: block; }
    .preview-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #14532d;
    }
    .preview-sub {
      font-size: 0.8rem;
      margin-top: 0.2rem;
    }
    .log-card {
      background: var(--card-bg);
      border-radius: 8px;
      padding: 0.9rem;
      margin-bottom: 0.9rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      border-left: 4px solid var(--secondary-color);
    }
    .log-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.4rem;
      padding-bottom: 0.3rem;
      border-bottom: 1px solid #e5e7eb;
    }
    .log-date {
      font-weight: 600;
      font-size: 0.95rem;
      color: #374151;
    }
    .log-actions {
      display: flex;
      gap: 0.3rem;
    }
    .log-main-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      margin-bottom: 0.4rem;
    }
    .log-km {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--primary-color);
    }
    .log-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.3rem 0.6rem;
      font-size: 0.85rem;
      color: #4b5563;
    }
    .log-stat-item span {
      display: block;
      font-size: 0.75rem;
      color: #6b7280;
    }
    .log-footer {
      margin-top: 0.4rem;
      font-size: 0.8rem;
      background: #f9fafb;
      padding: 0.3rem 0.4rem;
      border-radius: 4px;
    }
    .fuel-badge {
      display: inline-block;
      background: #e0e7ff;
      color: #3730a3;
      padding: 0.15rem 0.5rem;
      border-radius: 9999px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    .summary-card {
      background: var(--primary-color);
      color: #fff;
      border-radius: 10px;
      padding: 1.1rem 1rem 1rem;
      text-align: center;
      margin-bottom: 0.7rem;
    }
    .summary-main {
      font-size: 2rem;
      font-weight: 700;
      margin: 0.3rem 0;
    }
    .summary-sub {
      font-size: 0.9rem;
      opacity: 0.9;
    }
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 0.6rem;
      margin-top: 0.7rem;
    }
    .summary-box {
      background: rgba(255,255,255,0.12);
      padding: 0.7rem;
      border-radius: 6px;
      font-size: 0.85rem;
    }
    .import-section {
      margin-top: 0.5rem;
      padding: 0.7rem;
      border-radius: 8px;
      border: 2px dashed #d1d5db;
      background: #f9fafb;
      font-size: 0.8rem;
    }
    #notification {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #111827;
      color: #f9fafb;
      padding: 0.5rem 1rem;
      border-radius: 9999px;
      font-size: 0.8rem;
      display: none;
      z-index: 1000;
      box-shadow: 0 8px 20px rgba(0,0,0,0.4);
      white-space: nowrap;
    }
    .hidden { display: none; }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.7rem;
    }
    .settings-row {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 0.7rem;
      align-items: start;
    }
    .settings-row .form-group {
      margin-bottom: 0;
    }
    .settings-card {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 0.6rem;
    }
    .settings-card > label {
      margin-bottom: 0.45rem;
    }
    .load-group {
      display: grid;
      gap: 0.45rem;
    }
    .load-item {
      display: grid;
      gap: 0.25rem;
    }
    .load-label {
      font-size: 0.8rem;
      font-weight: 600;
      color: #6b7280;
    }
    .unit-select {
      display: flex;
      align-items: center;
      gap: 0.35rem;
    }
    .unit-select select {
      width: 100%;
      margin: 0;
    }
    .unit-suffix {
      min-width: 2.2em;
      text-align: right;
      font-size: 0.85rem;
      font-weight: 600;
      color: #4b5563;
      white-space: nowrap;
    }
    .load-filter-dropdown {
      position: relative;
    }
    .load-filter-summary {
      display: block;
      list-style: none;
      cursor: pointer;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      background: #fff;
      padding: 0.55rem 0.65rem;
      font-size: 0.85rem;
      font-weight: 600;
      color: #374151;
    }
    .load-filter-summary::-webkit-details-marker {
      display: none;
    }
    .load-filter-summary::after {
      content: "▼";
      float: right;
      font-size: 0.7rem;
      color: #6b7280;
      margin-top: 0.15rem;
    }
    .load-filter-dropdown[open] .load-filter-summary {
      border-color: var(--secondary-color);
      box-shadow: 0 0 0 3px rgba(59,130,246,0.15);
    }
    .load-filter-dropdown[open] .load-filter-summary::after {
      content: "▲";
    }
    .load-filter-menu {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 0.3rem;
      margin-top: 0.35rem;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      background: #fff;
      padding: 0.5rem;
    }
    .load-filter-menu input {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }
    .load-filter-chip {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-height: 2rem;
      padding: 0.2rem 0.3rem;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 0.8rem;
      font-weight: 600;
      color: #374151;
      background: #fff;
      cursor: pointer;
      user-select: none;
    }
    .load-filter-menu input:checked + .load-filter-chip {
      background: var(--primary-color);
      color: #fff;
      border-color: var(--primary-color);
    }
    .selected-values {
      margin-top: 0.2rem;
      font-size: 0.75rem;
      color: #4b5563;
      line-height: 1.4;
    }
    .unit-note {
      margin-bottom: 0.3rem;
      font-size: 0.75rem;
      color: #6b7280;
      font-weight: 600;
    }
    .toggle-group.inline-two {
      grid-template-columns: repeat(2, 1fr);
    }
    .route-checkbox-row {
      margin: 0.25rem 0 0.2rem;
    }
    .route-checkbox-row .toggle-group {
      max-width: 180px;
    }
    .summary-filter-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 0.7rem;
    }
    .summary-filter-card {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 0.6rem;
    }
    .summary-filter-title {
      font-size: 0.85rem;
      font-weight: 700;
      color: #374151;
      margin-bottom: 0.35rem;
    }
    @media (max-width: 640px) {
      .form-row,
      .settings-row,
      .summary-filter-grid {
        grid-template-columns: 1fr;
      }
      .load-filter-menu {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }
    .tag-primary {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.15rem 0.45rem;
      border-radius: 9999px;
      background: var(--primary-color);
      color: #fff;
      font-size: 0.75rem;
      font-weight: 600;
      line-height: 1;
    }
    small.hint { font-size: 0.75rem; color: #6b7280; }
    .build-info {
      margin-top: 0.8rem;
      font-size: 0.75rem;
      color: #6b7280;
      text-align: center;
    }
  </style>
</head>
<body>
<header>
  <h1>🚛 トラック燃費記録</h1>
</header>

<div class="container">
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('input')">入力</button>
    <button class="tab-btn" onclick="switchTab('list')">履歴</button>
    <button class="tab-btn" onclick="switchTab('summary')">集計</button>
  </div>

  <!-- 入力 -->
  <div id="view-input" class="tab-content">
    <div id="fuel-preview-card">
      <div>今回の計算結果プレビュー</div>
      <div class="preview-value" id="preview-efficiency">-</div>
      <div class="preview-sub">
        走行距離 <span id="preview-distance">0</span> km /
        給油: <span id="preview-fuel">0</span> L
      </div>
    </div>

    <div class="log-card" style="border-left-color: var(--accent-color);">
      <form id="fuelForm">
        <div class="form-group">
          <label for="date">日付</label>
          <input type="date" id="date" required>
        </div>
        <div class="form-group">
          <label for="odometer">積算距離 (km)</label>
          <input type="number" id="odometer"
                 placeholder="例: 123456.7" step="0.1" inputmode="decimal" required>
          <small id="last-odometer-hint" class="hint"></small>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="fuelA">給油A (L)</label>
            <!-- 小数点2桁対応 -->
            <input type="number" id="fuelA" step="0.01"
                   placeholder="主タンク" inputmode="decimal">
          </div>
          <div class="form-group">
            <label for="fuelB">給油B (L)</label>
            <!-- 小数点2桁対応 -->
            <input type="number" id="fuelB" step="0.01"
                   placeholder="サブタンク" inputmode="decimal">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="route-up">ルート（上り）</label>
            <select id="route-up" required>
              <option value="">選択してください</option>
              <option value="新名神－新東名">新名神－新東名</option>
              <option value="名神ー新東名">名神ー新東名</option>
              <option value="名神－中央">名神－中央</option>
              <option value="新名神－中央">新名神－中央</option>
            </select>
          </div>
          <div class="form-group">
            <label for="route-down">ルート（下り）</label>
            <select id="route-down" required>
              <option value="">選択してください</option>
              <option value="新東名ー新名神">新東名ー新名神</option>
              <option value="新東名ー名神">新東名ー名神</option>
              <option value="中央ー名神">中央ー名神</option>
              <option value="中央－新名神">中央－新名神</option>
              <option value="箱根ー新東名－新名神">箱根ー新東名－新名神</option>
              <option value="箱根ー新東名ー名神">箱根ー新東名ー名神</option>
            </select>
          </div>
        </div>
        <div class="form-group route-checkbox-row">
          <label>箱根新道</label>
          <div class="toggle-group">
            <input type="checkbox" id="hakone-shindo">
            <label class="toggle-btn" for="hakone-shindo">使用する</label>
          </div>
        </div>
        <div class="settings-row">
          <div class="form-group settings-card">
            <label>満タン</label>
            <div class="toggle-group">
              <input type="radio" name="fullness" id="full-yes" value="full" checked>
              <label class="toggle-btn" for="full-yes">満タン</label>
              <input type="radio" name="fullness" id="full-no" value="partial">
              <label class="toggle-btn" for="full-no">未満タン</label>
            </div>
          </div>
          <div class="form-group settings-card">
            <label>積載重量</label>
            <div class="load-group">
              <div class="load-item">
                <div class="load-label">上り</div>
                <div class="unit-select">
                  <select id="load-up">
                    <option value="0" selected>0</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                    <option value="11">11</option>
                    <option value="12">12</option>
                    <option value="13">13</option>
                  </select>
                  <span class="unit-suffix">トン</span>
                </div>
              </div>
              <div class="load-item">
                <div class="load-label">下り</div>
                <div class="unit-select">
                  <select id="load-down">
                    <option value="0" selected>0</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                    <option value="8">8</option>
                    <option value="9">9</option>
                    <option value="10">10</option>
                    <option value="11">11</option>
                    <option value="12">12</option>
                    <option value="13">13</option>
                  </select>
                  <span class="unit-suffix">トン</span>
                </div>
              </div>
            </div>
          </div>
          <div class="form-group settings-card">
            <label>速度MAX</label>
            <div class="toggle-group inline-two">
              <input type="checkbox" id="speed-up-max">
              <label class="toggle-btn" for="speed-up-max">上り</label>
              <input type="checkbox" id="speed-down-max">
              <label class="toggle-btn" for="speed-down-max">下り</label>
            </div>
          </div>
        </div>
        <button type="submit" class="btn btn-main" id="submitButton">
          💾 記録を追加する
        </button>
      </form>
    </div>

    <div class="build-info" id="build-info"></div>
  </div>

  <!-- 履歴 -->
  <div id="view-list" class="hidden tab-content">
    <button class="btn btn-toggle-import" onclick="toggleImportPanel()">
      📥 CSVインポート機能を開く
    </button>

    <div id="import-panel" class="import-section hidden">
      <div style="color:var(--import-color); font-weight:600; margin-bottom:0.3rem;">
        🚚 CSVインポート（ヘッダー自動判定！）
      </div>
      <div>※1行目をヘッダーとして、日付・距離・給油量の列を自動で探します。</div>
      <input type="file" id="csvFile" accept=".csv">
      <button class="btn btn-import" onclick="importCSV()">📥 インポート実行</button>
      <div style="margin-top:0.3rem; color:#6b7280;">
        桁区切り付き数値（例: 56,061.8）にも対応します。
      </div>
    </div>

    <div class="action-row">
      <button class="btn btn-export" onclick="exportCSV()">📤 CSVエクスポート</button>
      <button class="btn btn-full-danger" onclick="deleteAllLogs()">
        🗑️ 全データ削除
      </button>
    </div>

    <div id="logs-container">
      <p style="text-align:center; color:#888; padding:1.5rem 0;">
        データを読み込み中…
      </p>
    </div>
  </div>

  <!-- 集計 -->
  <div id="view-summary" class="hidden tab-content">
    <div class="form-group">
      <label for="summaryMonth">表示年月</label>
      <input type="month" id="summaryMonth" onchange="renderSummary()">
    </div>
    <div id="summary-content">
      <p style="text-align:center; color:#888; padding:2rem 0;">
        年月を選んで集計してください。
      </p>
    </div>
    <div class="log-card">
      <div style="font-weight:600; margin-bottom:0.4rem;">絞り込み</div>
      <div class="summary-filter-grid">
        <div class="summary-filter-card">
          <div class="summary-filter-title">積載重量</div>
          <div class="unit-note">トン</div>
          <div class="load-group">
            <div class="load-item">
              <div class="load-label">上り</div>
              <details class="load-filter-dropdown" id="filter-load-up-dropdown">
                <summary id="filter-load-up-summary" class="load-filter-summary">すべて</summary>
                <div id="filter-load-up-options" class="load-filter-menu"></div>
              </details>
              <div id="filter-load-up-selected" class="selected-values">選択中: すべて</div>
            </div>
            <div class="load-item">
              <div class="load-label">下り</div>
              <details class="load-filter-dropdown" id="filter-load-down-dropdown">
                <summary id="filter-load-down-summary" class="load-filter-summary">すべて</summary>
                <div id="filter-load-down-options" class="load-filter-menu"></div>
              </details>
              <div id="filter-load-down-selected" class="selected-values">選択中: すべて</div>
            </div>
          </div>
        </div>
        <div class="summary-filter-card">
          <div class="summary-filter-title">速度MAX</div>
          <div class="load-group">
            <div class="load-item">
              <div class="load-label">上り</div>
              <select id="filter-speed-up" onchange="updateSpeedFilter('up', this.value)">
                <option value="">すべて</option>
                <option value="yes">あり</option>
                <option value="no">なし</option>
              </select>
            </div>
            <div class="load-item">
              <div class="load-label">下り</div>
              <select id="filter-speed-down" onchange="updateSpeedFilter('down', this.value)">
                <option value="">すべて</option>
                <option value="yes">あり</option>
                <option value="no">なし</option>
              </select>
            </div>
          </div>
        </div>
        <div class="summary-filter-card">
          <div class="summary-filter-title">ルート</div>
          <div class="load-group">
            <div class="load-item">
              <div class="load-label">上り</div>
              <select id="filter-route-up" onchange="updateRouteFilter('up', this.value)">
                <option value="">すべて</option>
                <option value="新名神－新東名">新名神－新東名</option>
                <option value="名神ー新東名">名神ー新東名</option>
                <option value="名神－中央">名神－中央</option>
                <option value="新名神－中央">新名神－中央</option>
              </select>
            </div>
            <div class="load-item">
              <div class="load-label">下り</div>
              <select id="filter-route-down" onchange="updateRouteFilter('down', this.value)">
                <option value="">すべて</option>
                <option value="新東名ー新名神">新東名ー新名神</option>
                <option value="新東名ー名神">新東名ー名神</option>
                <option value="中央ー名神">中央ー名神</option>
                <option value="中央－新名神">中央－新名神</option>
                <option value="箱根ー新東名－新名神">箱根ー新東名－新名神</option>
                <option value="箱根ー新東名ー名神">箱根ー新東名ー名神</option>
              </select>
            </div>
            <div class="load-item">
              <div class="load-label">箱根新道</div>
              <select id="filter-hakone-shindo" onchange="updateHakoneShindoFilter(this.value)">
                <option value="">すべて</option>
                <option value="yes">あり</option>
                <option value="no">なし</option>
              </select>
            </div>
          </div>
        </div>
      </div>
      <div style="margin-top:0.4rem; font-size:0.75rem; color:#6b7280;">
        選択した条件の運行データを下に表示します。
      </div>
    </div>
    <div id="load-filter-results">
      <p style="text-align:center; color:#888; padding:1rem 0;">
        選択した条件の運行データがここに表示されます。
      </p>
    </div>
  </div>
</div>

<div id="notification">保存しました</div>

<script>
  const DB_NAME = 'TruckFuelDB';
  const DB_VERSION = 2;
  const STORE_NAME = 'logs';
  let db;
  let allLogs = [];
  let editingId = null;
  const summaryLoad = { up: [], down: [] };
  const summarySpeed = { up: '', down: '' };
  const ROUTE_UP_OPTIONS = [
    '新名神－新東名',
    '名神ー新東名',
    '名神－中央',
    '新名神－中央'
  ];
  const ROUTE_DOWN_OPTIONS = [
    '新東名ー新名神',
    '新東名ー名神',
    '中央ー名神',
    '中央－新名神',
    '箱根ー新東名－新名神',
    '箱根ー新東名ー名神'
  ];
  const ROUTE_ALL_OPTIONS = [...ROUTE_UP_OPTIONS, ...ROUTE_DOWN_OPTIONS];
  const ROUTE_PAIR_MAP = {
    '新名神－新東名': '新東名ー新名神',
    '名神ー新東名': '新東名ー名神',
    '名神－中央': '中央ー名神',
    '新名神－中央': '中央－新名神'
  };
  const ROUTE_PAIR_REVERSE_MAP = {
    '新東名ー新名神': '新名神－新東名',
    '新東名ー名神': '名神ー新東名',
    '中央ー名神': '名神－中央',
    '中央－新名神': '新名神－中央',
    '箱根ー新東名－新名神': '新名神－新東名',
    '箱根ー新東名ー名神': '名神ー新東名'
  };
  const summaryRoute = { up: '', down: '' };
  let summaryHakoneShindo = '';

  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('date').valueAsDate = new Date();
    document.getElementById('summaryMonth').value =
      new Date().toISOString().slice(0, 7);
    initDB();

    ['odometer', 'fuelA', 'fuelB'].forEach(id => {
      document.getElementById(id).addEventListener('input', updatePreview);
    });
    ['full-yes', 'full-no'].forEach(id => {
      document.getElementById(id).addEventListener('change', updatePreview);
    });
    document.getElementById('full-no').addEventListener('change', e => {
      if (e.target.checked) {
        showNotification('未満タン: 次回の満タンで合算します。');
      }
    });

    document.getElementById('fuelForm')
      .addEventListener('submit', handleSubmit);

    const buildInfo = document.getElementById('build-info');
    if (buildInfo) {
      const modified = new Date(document.lastModified);
      buildInfo.textContent = `更新: ${modified.toLocaleString('ja-JP')}`;
    }

    if ('serviceWorker' in navigator &&
        (location.protocol === 'http:' || location.protocol === 'https:')) {
      navigator.serviceWorker.register('./truck-sw.js').catch(console.error);
    }
    setupLoadFilterOptions();
    renderLoadFilterSelectionSummary('up');
    renderLoadFilterSelectionSummary('down');
  });

  function initDB() {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = e => {
      db = e.target.result;
      if (!db.objectStoreNames.contains(STORE_NAME)) {
        const store = db.createObjectStore(STORE_NAME,
                          { keyPath: 'id', autoIncrement: true });
        store.createIndex('date', 'date');
      }
    };
    req.onsuccess = e => { db = e.target.result; loadLogs(); };
    req.onerror = e => {
      console.error(e);
      showNotification('データベースが開けません。');
    };
  }

  function handleSubmit(e) {
    e.preventDefault();
    const isFull = document.getElementById('full-yes').checked;
    const loadUp = normalizeLoadValue(document.getElementById('load-up').value);
    const loadDown =
      normalizeLoadValue(document.getElementById('load-down').value);
    const speedUpMax = document.getElementById('speed-up-max').checked;
    const speedDownMax = document.getElementById('speed-down-max').checked;
    const routeUpInput = document.getElementById('route-up').value;
    const routeDownInput = document.getElementById('route-down').value;
    const hakoneShindoInput = document.getElementById('hakone-shindo').checked;
    const routeUp = normalizeRouteValue(routeUpInput);
    const routeDown = normalizeRouteValue(routeDownInput);
    const data = {
      date: document.getElementById('date').value,
      odometer: parseFloat(document.getElementById('odometer').value),
      routeUp,
      routeDown,
      hakoneShindo: hakoneShindoInput || isHakoneRouteDownValue(routeDown),
      fuelA: parseFloat(document.getElementById('fuelA').value) || 0,
      fuelB: parseFloat(document.getElementById('fuelB').value) || 0,
      loadUp,
      loadDown,
      speedUpMax,
      speedDownMax,
      isFull,
      timestamp: Date.now()
    };
    if (!data.date || isNaN(data.odometer)) {
      showNotification('日付と積算距離は必須です。');
      return;
    }
    if (!routeUp || !routeDown) {
      showNotification('上りと下りのルートを選択してください。');
      return;
    }
    if (editingId !== null) {
      updateLog(editingId, data);
    } else {
      addLog(data);
    }
  }

  function addLog(data) {
    if (!db) return;
    const tx = db.transaction([STORE_NAME], 'readwrite');
    tx.objectStore(STORE_NAME).add(data);
    tx.oncomplete = () => {
      resetForm();
      loadLogs(() => {
        exportBackupCSV().then(didBackup => {
          showNotification(
            didBackup ? '記録を追加しました。CSVを保存しました。' : '記録を追加しました。'
          );
        });
      });
    };
    tx.onerror = () => showNotification('記録に失敗しました。');
  }

  function updateLog(id, data) {
    if (!db) return;
    const tx = db.transaction([STORE_NAME], 'readwrite');
    const store = tx.objectStore(STORE_NAME);
    const req = store.get(id);
    req.onsuccess = () => {
      const old = req.result;
      if (!old) { addLog(data); return; }
      const updated = { ...old, ...data, id };
      store.put(updated);
    };
    tx.oncomplete = () => {
      resetForm();
      loadLogs(() => {
        exportBackupCSV().then(didBackup => {
          showNotification(
            didBackup ? '記録を更新しました。CSVを保存しました。' : '記録を更新しました。'
          );
        });
      });
    };
    tx.onerror = () => showNotification('更新に失敗しました。');
  }

  function resetForm() {
    editingId = null;
    document.getElementById('fuelForm').reset();
    document.getElementById('date').valueAsDate = new Date();
    document.getElementById('submitButton').textContent = '💾 記録を追加する';
    document.getElementById('fuel-preview-card').classList.remove('visible');
    document.getElementById('full-yes').checked = true;
    document.getElementById('route-up').value = '';
    document.getElementById('route-down').value = '';
    document.getElementById('hakone-shindo').checked = false;
    document.getElementById('load-up').value = '0';
    document.getElementById('load-down').value = '0';
    document.getElementById('speed-up-max').checked = false;
    document.getElementById('speed-down-max').checked = false;
  }

  function loadLogs(onLoaded) {
    if (!db) return;
    const tx = db.transaction([STORE_NAME], 'readonly');
    tx.objectStore(STORE_NAME).getAll().onsuccess = e => {
      const raw = e.target.result || [];
      raw.sort((a, b) => {
        if (a.date === b.date) return (a.odometer || 0) - (b.odometer || 0);
        return a.date < b.date ? -1 : 1;
      });
      let lastFullOdo = null;
      let pendingFuel = 0;
      let pendingStartOdo = null;
      allLogs = raw.map((log, idx) => {
        const isFull = log.isFull !== false;
        let distance = 0;
        let isFirst = false;
        let isAggregated = false;
        let isDeferred = false;
        const fuelNow =
          (parseFloat(log.fuelA) || 0) + (parseFloat(log.fuelB) || 0);
        let totalFuel = fuelNow;
        if (!isFull) {
          pendingFuel += fuelNow;
          if (pendingStartOdo === null && typeof log.odometer === 'number') {
            pendingStartOdo = log.odometer;
          }
          isDeferred = true;
        } else {
          const startOdo =
            lastFullOdo !== null ? lastFullOdo : pendingStartOdo;
          totalFuel = fuelNow + pendingFuel;
          if (pendingFuel > 0) isAggregated = true;
          if (pendingFuel > 0 && startOdo !== null && typeof log.odometer === 'number') {
            const d = (log.odometer || 0) - (startOdo || 0);
            if (d > 0) distance = d;
            else isFirst = true;
          } else if (Number.isFinite(log.csvDistance) && log.csvDistance > 0) {
            distance = log.csvDistance;
          } else if (startOdo !== null && typeof log.odometer === 'number') {
            const d = (log.odometer || 0) - (startOdo || 0);
            if (d > 0) distance = d;
            else isFirst = true;
          } else if (idx === 0) {
            isFirst = true;
          } else {
            isFirst = true;
          }
          pendingFuel = 0;
          pendingStartOdo = null;
          if (typeof log.odometer === 'number') {
            lastFullOdo = log.odometer;
          }
        }
        const efficiency =
          distance > 0 && totalFuel > 0 ? distance / totalFuel : 0;
        const enriched = {
          ...log,
          loadUp: normalizeLoadValue(log.loadUp),
          loadDown: normalizeLoadValue(log.loadDown),
          isFull,
          distance,
          totalFuel,
          efficiency,
          isFirst,
          isAggregated,
          isDeferred
        };
        return enriched;
      });

      if (allLogs.length > 0) {
        const last = allLogs[allLogs.length - 1];
        document.getElementById('last-odometer-hint').textContent =
          `最新の記録: ${last.date} / ${formatNumber(last.odometer)} km`;
      } else {
        document.getElementById('last-odometer-hint').textContent =
          'まだ記録がありません。';
      }

      renderList();
      renderSummary();
      updatePreview();
      if (typeof onLoaded === 'function') onLoaded();
    };
  }

  function updatePreview() {
    const card = document.getElementById('fuel-preview-card');
    if (allLogs.length === 0) { card.classList.remove('visible'); return; }
    if (!document.getElementById('full-yes').checked) {
      card.classList.remove('visible');
      return;
    }
    const odo = parseFloat(document.getElementById('odometer').value);
    const fuelA = parseFloat(document.getElementById('fuelA').value) || 0;
    const fuelB = parseFloat(document.getElementById('fuelB').value) || 0;
    const totalFuelInput = fuelA + fuelB;
    if (!odo || totalFuelInput <= 0) {
      card.classList.remove('visible');
      return;
    }
    const state = getPendingState();
    const startOdo =
      state.lastFullOdo !== null ? state.lastFullOdo : state.pendingStartOdo;
    if (startOdo === null) {
      card.classList.remove('visible');
      return;
    }
    const dist = odo - (startOdo || 0);
    const totalFuel = totalFuelInput + state.pendingFuel;
    if (dist <= 0) {
      card.classList.remove('visible');
      return;
    }
    document.getElementById('preview-distance').textContent =
      formatNumber(dist);
    document.getElementById('preview-fuel').textContent =
      totalFuel.toFixed(1);
    document.getElementById('preview-efficiency').textContent =
      (dist / totalFuel).toFixed(2) + ' km/L';
    card.classList.add('visible');
  }

  function renderList() {
    const container = document.getElementById('logs-container');
    container.innerHTML = '';
    if (allLogs.length === 0) {
      container.innerHTML =
        '<p style="text-align:center; padding:2rem 0; color:#888;">まだデータがありません。</p>';
      return;
    }
    [...allLogs].slice().reverse().forEach(log => {
      const dateStr = log.date || '';
      const fuelText = log.totalFuel > 0 ? log.totalFuel.toFixed(1) : '-';
      const effText = log.isFirst || !log.isFull || log.efficiency <= 0
        ? '-'
        : log.efficiency.toFixed(2);
      const distText = !log.isFull
        ? '(未満タン)'
        : log.isFirst || log.distance <= 0
        ? '(初回)'
        : '+' + formatNumber(log.distance) + ' km';
      const routeText = routePairLabel(getRoutePair(log));
      const loadText = loadPairLabel(log.loadUp, log.loadDown);
      const speedText = speedMaxLabel(log);
      const memoText = [
        log.isFull ? '' : '未満タン',
        log.isAggregated ? '⚠️ 合算あり' : '',
        loadText,
        speedText,
        hakoneShindoLabel(log),
        log.memo ? escapeHtml(log.memo) : ''
      ].filter(Boolean).join(' ');
      container.insertAdjacentHTML('beforeend', `
        <div class="log-card">
          <div class="log-header">
            <span class="log-date">${escapeHtml(dateStr)}</span>
            <div class="log-actions">
              <button class="btn btn-small" onclick="editLog(${log.id})">
                編集
              </button>
              <button class="btn btn-danger" onclick="deleteLog(${log.id})">
                削除
              </button>
            </div>
          </div>
          <div class="log-main-row">
            <div>
              <span style="font-size:0.8rem; color:#6b7280;">今回燃費</span><br>
              <span class="log-km">${effText}</span>
              <span style="font-size:0.85rem;">km/L</span>
            </div>
            <div style="text-align:right;">
              <span style="font-size:0.8rem; color:#6b7280;">走行距離</span><br>
              <span style="font-weight:600;">${distText}</span>
            </div>
          </div>
          <div class="log-details">
            <div class="log-stat-item">
              <span>積算距離</span>
              ${formatNumber(log.odometer)} km
            </div>
            <div class="log-stat-item">
              <span>給油合計</span>
              <span class="fuel-badge">${fuelText} L</span>
            </div>
            <div class="log-stat-item">
              <span>ルート</span>
              ${routeText ? escapeHtml(routeText) : '-'}
            </div>
          </div>
          ${memoText ? `<div class="log-footer">${memoText}</div>` : ''}
        </div>
      `);
    });
  }

  function editLog(id) {
    const log = allLogs.find(l => l.id === id);
    if (!log) return;
    editingId = id;
    document.getElementById('date').value = log.date;
    document.getElementById('odometer').value = log.odometer;
    document.getElementById('fuelA').value = log.fuelA || '';
    document.getElementById('fuelB').value = log.fuelB || '';
    document.getElementById('full-yes').checked = log.isFull !== false;
    document.getElementById('full-no').checked = log.isFull === false;
    const routeUpSelect = document.getElementById('route-up');
    const routeDownSelect = document.getElementById('route-down');
    const routePair = getRoutePair(log);
    if (routeUpSelect) {
      routeUpSelect.value = ROUTE_UP_OPTIONS.includes(routePair.up)
        ? routePair.up
        : '';
    }
    if (routeDownSelect) {
      routeDownSelect.value = ROUTE_DOWN_OPTIONS.includes(routePair.down)
        ? routePair.down
        : '';
    }
    document.getElementById('load-up').value =
      normalizeLoadValue(log.loadUp) || '0';
    document.getElementById('load-down').value =
      normalizeLoadValue(log.loadDown) || '0';
    document.getElementById('speed-up-max').checked = !!log.speedUpMax;
    document.getElementById('speed-down-max').checked = !!log.speedDownMax;
    document.getElementById('hakone-shindo').checked = isHakoneShindoEnabled(log);
    document.getElementById('submitButton').textContent = '✏️ 記録を更新する';
    switchTab('input');
    updatePreview();
  }

  function deleteLog(id) {
    if (!db) return;
    if (!confirm('この記録を削除しますか？')) return;
    const tx = db.transaction([STORE_NAME], 'readwrite');
    tx.objectStore(STORE_NAME).delete(id);
    tx.oncomplete = () => {
      loadLogs(() => {
        exportBackupCSV().then(didBackup => {
          showNotification(
            didBackup ? '削除しました。CSVを保存しました。' : '削除しました。'
          );
        });
      });
    };
  }

  function deleteAllLogs() {
    if (!db) return;
    if (!confirm('本当に全データを削除しますか？')) return;
    const tx = db.transaction([STORE_NAME], 'readwrite');
    tx.objectStore(STORE_NAME).clear();
    tx.oncomplete = () => {
      allLogs = [];
      renderList();
      renderSummary();
      showNotification('全データを削除しました。');
    };
  }

  function renderSummary() {
    const month = document.getElementById('summaryMonth').value;
    const container = document.getElementById('summary-content');
    if (!month) {
      container.innerHTML =
        '<p style="text-align:center; padding:2rem 0; color:#888;">' +
        '年月を選んで集計してください。</p>';
      renderLoadFilterResults();
      return;
    }
    const monthly = allLogs.filter(l => (l.date || '').startsWith(month));
    if (monthly.length === 0) {
      container.innerHTML =
        '<p style="text-align:center; padding:2rem 0; color:#888;">データがありません。</p>';
      renderLoadFilterResults();
      return;
    }
    let dist = 0;
    let fuel = 0;
    let hakoneCount = 0;
    monthly.forEach(l => {
      if (isHakoneShindoEnabled(l)) hakoneCount += 1;
      if (l.isFull && !l.isFirst && l.distance > 0 && l.totalFuel > 0) {
        dist += l.distance;
        fuel += l.totalFuel;
      }
    });
    const avg = dist > 0 && fuel > 0 ? (dist / fuel).toFixed(2) : '-';
    container.innerHTML = `
      <div class="summary-card">
        <div>月平均燃費</div>
        <div class="summary-main">
          ${avg} <span style="font-size:0.9rem;">km/L</span>
        </div>
        <div class="summary-sub">${month}</div>
        <div class="summary-grid">
          <div class="summary-box">
            <div>総走行距離</div>
            <div style="font-weight:600; font-size:1.1rem;">
              ${formatNumber(dist)} km
            </div>
          </div>
          <div class="summary-box">
            <div>総給油量</div>
            <div style="font-weight:600; font-size:1.1rem;">
              ${fuel.toFixed(1)} L
            </div>
          </div>
          <div class="summary-box">
            <div>箱根新道運行</div>
            <div style="font-weight:600; font-size:1.1rem;">
              ${hakoneCount} 件
            </div>
          </div>
        </div>
      </div>
    `;
    renderLoadFilterResults();
  }

  function updateLoadFilter(direction) {
    if (!Object.prototype.hasOwnProperty.call(summaryLoad, direction)) return;
    summaryLoad[direction] = collectCheckedLoadFilterValues(direction);
    renderLoadFilterSelectionSummary(direction);
    renderLoadFilterResults();
  }

  function updateRouteFilter(direction, value) {
    if (!Object.prototype.hasOwnProperty.call(summaryRoute, direction)) return;
    summaryRoute[direction] = normalizeRouteValue(value);
    renderLoadFilterResults();
  }
  function updateHakoneShindoFilter(value) {
    summaryHakoneShindo = normalizeYesNoValue(value);
    renderLoadFilterResults();
  }
  function updateSpeedFilter(direction, value) {
    if (!Object.prototype.hasOwnProperty.call(summarySpeed, direction)) return;
    summarySpeed[direction] = normalizeSpeedFilterValue(value);
    renderLoadFilterResults();
  }

  function renderLoadFilterResults() {
    const container = document.getElementById('load-filter-results');
    if (!container) return;
    const selectedUp = Array.isArray(summaryLoad.up) ? summaryLoad.up : [];
    const selectedDown = Array.isArray(summaryLoad.down) ? summaryLoad.down : [];
    const selectedSpeedUp = summarySpeed.up;
    const selectedSpeedDown = summarySpeed.down;
    const selectedHakoneShindo = summaryHakoneShindo;
    const hasRouteFilter = !!summaryRoute.up || !!summaryRoute.down;
    const hasLoadSelection = selectedUp.length > 0 || selectedDown.length > 0;
    const hasSpeedFilter = !!selectedSpeedUp || !!selectedSpeedDown;
    const hasHakoneFilter = !!selectedHakoneShindo;
    if (!hasLoadSelection && !hasRouteFilter && !hasSpeedFilter && !hasHakoneFilter) {
      container.innerHTML =
        '<p style="text-align:center; color:#888; padding:1rem 0;">' +
        '選択した条件の運行データがここに表示されます。</p>';
      return;
    }
    const filtered = allLogs.filter(log => {
      const normalizedUp = normalizeLoadValue(log.loadUp);
      const normalizedDown = normalizeLoadValue(log.loadDown);
      const upMatch = selectedUp.length === 0 || selectedUp.includes(normalizedUp);
      const downMatch = selectedDown.length === 0 || selectedDown.includes(normalizedDown);
      const routePair = getRoutePair(log);
      const routeUpMatch = !summaryRoute.up || routePair.up === summaryRoute.up;
      const routeDownMatch =
        !summaryRoute.down || routePair.down === summaryRoute.down;
      const routeMatch = !hasRouteFilter || (routeUpMatch && routeDownMatch);
      const loadMatch = !hasLoadSelection || (upMatch && downMatch);
      const speedUpMatch = !selectedSpeedUp ||
        (selectedSpeedUp === 'yes' ? !!log.speedUpMax : !log.speedUpMax);
      const speedDownMatch = !selectedSpeedDown ||
        (selectedSpeedDown === 'yes' ? !!log.speedDownMax : !log.speedDownMax);
      const hakoneEnabled = isHakoneShindoEnabled(log);
      const hakoneMatch = !hasHakoneFilter ||
        (selectedHakoneShindo === 'yes' ? hakoneEnabled : !hakoneEnabled);
      return loadMatch && routeMatch && speedUpMatch && speedDownMatch && hakoneMatch;
    });
    if (filtered.length === 0) {
      container.innerHTML =
        '<p style="text-align:center; color:#888; padding:1rem 0;">' +
        '該当する運行がありません。</p>';
      return;
    }
    const cards = filtered.slice().reverse().map(log => {
      const dateStr = log.date || '';
      const fuelText = log.totalFuel > 0 ? log.totalFuel.toFixed(1) : '-';
      const effText = log.isFirst || !log.isFull || log.efficiency <= 0
        ? '-'
        : log.efficiency.toFixed(2);
      const distText = !log.isFull
        ? '(未満タン)'
        : log.isFirst || log.distance <= 0
        ? '(初回)'
        : '+' + formatNumber(log.distance) + ' km';
      const loadText = loadPairLabel(log.loadUp, log.loadDown);
      const routeText = routePairLabel(getRoutePair(log));
      const speedText = speedMaxLabel(log);
      const footerText = [
        loadText ? `積載: ${loadText}` : '',
        speedText,
        hakoneShindoLabel(log),
        log.memo ? escapeHtml(log.memo) : ''
      ].filter(Boolean).join(' ');
      return `
        <div class="log-card">
          <div class="log-header">
            <span class="log-date">${escapeHtml(dateStr)}</span>
          </div>
          <div class="log-main-row">
            <div>
              <span style="font-size:0.8rem; color:#6b7280;">今回燃費</span><br>
              <span class="log-km">${effText}</span>
              <span style="font-size:0.85rem;">km/L</span>
            </div>
            <div style="text-align:right;">
              <span style="font-size:0.8rem; color:#6b7280;">走行距離</span><br>
              <span style="font-weight:600;">${distText}</span>
            </div>
          </div>
          <div class="log-details">
            <div class="log-stat-item">
              <span>積算距離</span>
              ${formatNumber(log.odometer)} km
            </div>
            <div class="log-stat-item">
              <span>給油合計</span>
              <span class="fuel-badge">${fuelText} L</span>
            </div>
            <div class="log-stat-item">
              <span>ルート</span>
              ${routeText ? escapeHtml(routeText) : '-'}
            </div>
          </div>
          ${footerText ? `<div class="log-footer">${footerText}</div>` : ''}
        </div>
      `;
    }).join('');
    container.innerHTML = cards;
  }

  function switchTab(tab) {
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.classList.remove('active');
    });
    document
      .querySelector(`.tab-btn[onclick*="${tab}"]`)
      .classList.add('active');
    document.querySelectorAll('.tab-content').forEach(v => {
      v.classList.add('hidden');
    });
    document.getElementById(`view-${tab}`).classList.remove('hidden');
    if (tab === 'list') renderList();
    if (tab === 'summary') renderSummary();
  }

  function toggleImportPanel() {
    const panel = document.getElementById('import-panel');
    panel.classList.toggle('hidden');
  }

  function importCSV() {
    const file = document.getElementById('csvFile').files[0];
    if (!file) {
      showNotification('CSVファイルを選んでください。');
      return;
    }
    const reader = new FileReader();
    reader.onload = e => parseAndImport(e.target.result);
    reader.readAsText(file, 'UTF-8');
  }

  function parseAndImport(csv) {
    if (!db) return;
    const lines = csv.split(/\r?\n/).map(l => l.trim()).filter(l => l);
    if (lines.length <= 1) {
      showNotification('有効なデータが見つかりません。');
      return;
    }

    const header = lines[0].split(',').map(cleanCell);
    let dateIdx = 0;
    let odoIdx = 1;
    let distIdx = -1;
    let fuelAIdx = -1;
    let fuelBIdx = -1;
    let fuelTotalIdx = -1;
    let memoIdx = -1;
    let routeUpIdx = -1;
    let routeDownIdx = -1;
    let routeIdx = -1;
    let loadUpIdx = -1;
    let loadDownIdx = -1;
    let speedUpIdx = -1;
    let speedDownIdx = -1;
    let hakoneShindoIdx = -1;

    header.forEach((name, i) => {
      if (/(日付|date)/i.test(name)) dateIdx = i;
      if (/(積算走行距離|積算距離|オド|メータ)/i.test(name)) odoIdx = i;
      if (/(走行距離|走行)/i.test(name) && !/積算/.test(name)) distIdx = i;
      if (/(給油A|給油\s*A)/i.test(name)) fuelAIdx = i;
      if (/(給油B|給油\s*B)/i.test(name)) fuelBIdx = i;
      if (/(給油量|給油合計|合計燃料|燃料|L)/i.test(name)) fuelTotalIdx = i;
      if (/(メモ|備考|note)/i.test(name)) memoIdx = i;
      if (/(上り.*ルート|ルート.*上り)/i.test(name)) { routeUpIdx = i; return; }
      if (/(下り.*ルート|ルート.*下り)/i.test(name)) { routeDownIdx = i; return; }
      if (/(ルート|route)/i.test(name)) routeIdx = i;
      if (/(上り積載|上り重量|上り荷)/i.test(name)) loadUpIdx = i;
      if (/(下り積載|下り重量|下り荷)/i.test(name)) loadDownIdx = i;
      if (/(上り速度|max上り|上りmax|上り速度max|上り速度MAX)/i.test(name)) speedUpIdx = i;
      if (/(下り速度|max下り|下りmax|下り速度max|下り速度MAX)/i.test(name)) speedDownIdx = i;
      if (/(箱根新道|箱根.*新道|hakone.*shindo|hakone_shindo)/i.test(name)) {
        hakoneShindoIdx = i;
      }
      if (loadUpIdx < 0 && /上り/i.test(name) && !/(速度|max|ルート|route)/i.test(name)) {
        loadUpIdx = i;
      }
      if (loadDownIdx < 0 && /下り/i.test(name) && !/(速度|max|ルート|route)/i.test(name)) {
        loadDownIdx = i;
      }
    });
    if (fuelAIdx < 0 && fuelTotalIdx >= 0) fuelAIdx = fuelTotalIdx;
    if (fuelAIdx < 0) fuelAIdx = 2;

    const records = [];
    for (let i = 1; i < lines.length; i++) {
      const cols = lines[i].split(',').map(cleanCell);
      if (!cols[dateIdx] && !cols[odoIdx]) continue;
      const date = cols[dateIdx].replace(/\./g, '-').replace(/\//g, '-');
      const odoStr = toHalfWidth(cols[odoIdx]).replace(/,/g, '');
      const distStr = distIdx >= 0
        ? toHalfWidth(cols[distIdx] || '').replace(/,/g, '')
        : '';
      const fuelAStr = toHalfWidth(cols[fuelAIdx] || '').replace(/,/g, '');
      const fuelBStr = fuelBIdx >= 0
        ? toHalfWidth(cols[fuelBIdx] || '').replace(/,/g, '')
        : '';
      const routeUpStr = routeUpIdx >= 0 ? cols[routeUpIdx] : '';
      const routeDownStr = routeDownIdx >= 0 ? cols[routeDownIdx] : '';
      const routeStr = routeIdx >= 0 ? cols[routeIdx] : '';
      const loadUpStr = loadUpIdx >= 0 ? cols[loadUpIdx] : '';
      const loadDownStr = loadDownIdx >= 0 ? cols[loadDownIdx] : '';
      const speedUpStr = speedUpIdx >= 0 ? cols[speedUpIdx] : '';
      const speedDownStr = speedDownIdx >= 0 ? cols[speedDownIdx] : '';
      const hakoneShindoStr = hakoneShindoIdx >= 0 ? cols[hakoneShindoIdx] : '';
      const odo = parseFloat(odoStr);
      const csvDistance = parseFloat(distStr);
      const fuelA = parseFloat(fuelAStr);
      const fuelB = parseFloat(fuelBStr) || 0;
      const routeUp = normalizeRouteValue(routeUpStr);
      const routeDown = normalizeRouteValue(routeDownStr);
      const routeFallback = normalizeRouteValue(routeStr);
      let finalRouteUp = routeUp || routeFallback;
      let finalRouteDown = routeDown;
      if (!finalRouteDown && finalRouteUp) {
        finalRouteDown = deriveDownRouteFromUp(finalRouteUp);
      }
      if (!finalRouteUp && finalRouteDown) {
        finalRouteUp = deriveUpRouteFromDown(finalRouteDown);
      }
      const loadUp = parseLoadValue(loadUpStr);
      const loadDown = parseLoadValue(loadDownStr);
      const speedUpMax = parseBoolCell(speedUpStr);
      const speedDownMax = parseBoolCell(speedDownStr);
      const hakoneShindo = parseBoolCell(hakoneShindoStr);
      const finalHakoneShindo = hakoneShindo || isHakoneRouteDownValue(finalRouteDown);
      if (!date || isNaN(odo) || isNaN(fuelA)) continue;
      const record = {
        date,
        odometer: odo,
        fuelA,
        fuelB,
        memo: memoIdx >= 0 ? cols[memoIdx] : `CSV行${i + 1}`,
        csvDistance: Number.isFinite(csvDistance) ? csvDistance : undefined,
        hakoneShindo: finalHakoneShindo,
        isFull: true,
        timestamp: Date.now()
      };
      if (finalRouteUp) record.routeUp = finalRouteUp;
      if (finalRouteDown) record.routeDown = finalRouteDown;
      if (loadUp) record.loadUp = loadUp;
      if (loadDown) record.loadDown = loadDown;
      if (speedUpMax) record.speedUpMax = true;
      if (speedDownMax) record.speedDownMax = true;
      records.push(record);
    }
    if (records.length === 0) {
      showNotification('取り込める行がありませんでした。');
      return;
    }

    const existingKey = new Set(
      allLogs.map(l => `${l.date}|${l.odometer}`)
    );
    const toImport = records.filter(r =>
      !existingKey.has(`${r.date}|${r.odometer}`)
    );

    if (toImport.length === 0) {
      showNotification('新規データはありませんでした。');
      return;
    }

    const tx = db.transaction([STORE_NAME], 'readwrite');
    const store = tx.objectStore(STORE_NAME);
    toImport.forEach(r => store.add(r));
    tx.oncomplete = () => {
      showNotification(`${toImport.length}件インポートしました。`);
      document.getElementById('csvFile').value = '';
      loadLogs();
    };
  }

  function buildCSVText() {
    let csv =
      '日付,積算距離,走行距離,給油A,給油B,合計燃料,燃費,上りルート,下りルート,上り積載,下り積載,上り速度MAX,下り速度MAX,箱根新道,メモ\n';
    allLogs.forEach(l => {
      const routePair = getRoutePair(l);
      csv += [
        l.date,
        l.odometer,
        l.isFirst ? 0 : l.distance,
        l.fuelA || 0,
        l.fuelB || 0,
        l.totalFuel || 0,
        l.isFirst ? 0 : l.efficiency.toFixed(2),
        routeLabel(routePair.up),
        routeLabel(routePair.down),
        loadLabel(l.loadUp),
        loadLabel(l.loadDown),
        l.speedUpMax ? '1' : '',
        l.speedDownMax ? '1' : '',
        isHakoneShindoEnabled(l) ? '1' : '',
        `"${(l.memo || '').replace(/"/g, '""')}"`
      ].join(',') + '\n';
    });
    return csv;
  }
  function createCSVBlob() {
    const csv = buildCSVText();
    return new Blob(
      [new Uint8Array([0xEF, 0xBB, 0xBF]), csv],
      { type: 'text/csv' }
    );
  }
  function exportCSV() {
    if (!db) {
      showNotification('データベースが開けません。');
      return;
    }
    loadLogs(() => {
      if (allLogs.length === 0) {
        showNotification('データがありません。');
        return;
      }
      const blob = createCSVBlob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'truck_log.csv';
      a.click();
      URL.revokeObjectURL(url);
    });
  }
  async function exportBackupCSV() {
    if (!db) return false;
    await new Promise(resolve => loadLogs(resolve));
    if (allLogs.length === 0) return false;
    const ok = confirm('CSVバックアップを保存しますか？保存先フォルダーを確認してください。');
    if (!ok) return false;
    if (window.showSaveFilePicker) {
      try {
        const stamp = new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-');
        const handle = await window.showSaveFilePicker({
          suggestedName: `truck_log_${stamp}.csv`,
          types: [{ description: 'CSV', accept: { 'text/csv': ['.csv'] } }]
        });
        const writable = await handle.createWritable();
        await writable.write(createCSVBlob());
        await writable.close();
        return true;
      } catch (err) {
        return false;
      }
    }
    const fallback = confirm(
      'このブラウザでは保存先フォルダーを選択できません。通常のダウンロードで保存しますか？'
    );
    if (!fallback) return false;
    exportCSV();
    return true;
  }

  function getPendingState() {
    let pendingFuel = 0;
    let pendingStartOdo = null;
    let lastFullOdo = null;
    allLogs.forEach(log => {
      const isFull = log.isFull !== false;
      const fuelNow =
        (parseFloat(log.fuelA) || 0) + (parseFloat(log.fuelB) || 0);
      if (!isFull) {
        pendingFuel += fuelNow;
        if (pendingStartOdo === null && typeof log.odometer === 'number') {
          pendingStartOdo = log.odometer;
        }
      } else {
        pendingFuel = 0;
        pendingStartOdo = null;
        if (typeof log.odometer === 'number') {
          lastFullOdo = log.odometer;
        }
      }
    });
    return { pendingFuel, pendingStartOdo, lastFullOdo };
  }
  function showNotification(msg) {
    const el = document.getElementById('notification');
    el.textContent = msg;
    el.style.display = 'block';
    setTimeout(() => { el.style.display = 'none'; }, 4000);
  }

  function toHalfWidth(str) {
    return (str || '').replace(/[０-９－．，]/g, ch => {
      const code = ch.charCodeAt(0);
      if (ch === '．') return '.';
      if (ch === '，') return ',';
      if (ch === '－') return '-';
      return String.fromCharCode(code - 0xFEE0);
    });
  }
  function cleanCell(c) {
    return c.replace(/^"|"$/g, '').trim();
  }
  function parseBoolCell(value) {
    const v = toHalfWidth(value || '').trim().toLowerCase();
    if (!v) return false;
    if (['1', 'true', 'yes', 'y', 'on', 'ok'].includes(v)) return true;
    if (v.includes('有') || v.includes('あり') || v.includes('〇') || v.includes('○')) {
      return true;
    }
    if (v.includes('速度max') || v.includes('max')) return true;
    return false;
  }
  function normalizeRouteValue(value) {
    const raw = (value || '').trim();
    if (!raw) return '';
    const compact = raw.replace(/\s+/g, '');
    const normalized = compact.replace(/[‐‑‒–—―－ー-]/g, '-');
    if (normalized === '新名神-新東名') return '新名神－新東名';
    if (normalized === '名神-新東名') return '名神ー新東名';
    if (normalized === '名神-中央') return '名神－中央';
    if (normalized === '新名神-中央') return '新名神－中央';
    if (normalized === '新東名-新名神') return '新東名ー新名神';
    if (normalized === '新東名-名神') return '新東名ー名神';
    if (normalized === '中央-名神') return '中央ー名神';
    if (normalized === '中央-新名神') return '中央－新名神';
    if (normalized === '箱根-新東名-新名神') return '箱根ー新東名－新名神';
    if (normalized === '箱根-新東名-名神') return '箱根ー新東名ー名神';
    return raw;
  }
  function routeLabel(value) {
    const normalized = normalizeRouteValue(value);
    if (ROUTE_ALL_OPTIONS.includes(normalized)) return normalized;
    return normalized || '';
  }
  function deriveDownRouteFromUp(value) {
    const normalized = normalizeRouteValue(value);
    return ROUTE_PAIR_MAP[normalized] || '';
  }
  function deriveUpRouteFromDown(value) {
    const normalized = normalizeRouteValue(value);
    return ROUTE_PAIR_REVERSE_MAP[normalized] || '';
  }
  function getRoutePair(log) {
    const upRaw = log.routeUp || log.route || '';
    const downRaw = log.routeDown || '';
    let up = normalizeRouteValue(upRaw);
    let down = normalizeRouteValue(downRaw);
    if (!up && down) up = deriveUpRouteFromDown(down);
    if (!down && up) down = deriveDownRouteFromUp(up);
    return { up, down };
  }
  function routePairLabel(pair) {
    const upLabel = routeLabel(pair.up);
    const downLabel = routeLabel(pair.down);
    if (!upLabel && !downLabel) return '';
    return `上り:${upLabel || '-'} / 下り:${downLabel || '-'}`;
  }
  function loadPairLabel(loadUpValue, loadDownValue) {
    const upLabel = loadLabel(loadUpValue);
    const downLabel = loadLabel(loadDownValue);
    if (!upLabel && !downLabel) return '';
    return `上り:${upLabel || '-'} / 下り:${downLabel || '-'} トン`;
  }
  function loadLabel(value) {
    const normalized = normalizeLoadValue(value);
    return normalized === '' ? '' : normalized;
  }
  function normalizeLoadValue(value) {
    const v = toHalfWidth(value || '').trim().toLowerCase();
    if (!v) return '';
    const compact = v.replace(/\s+/g, '');
    const direct = compact.match(/^(\d{1,2})(?:トン|ton|t)?$/);
    if (direct) {
      const n = parseInt(direct[1], 10);
      if (n >= 0 && n <= 13) return String(n);
      return '';
    }
    if (compact.includes('heavy') || compact.includes('重')) return '13';
    if (compact.includes('medium') || compact.includes('middle') || compact.includes('中')) {
      return '7';
    }
    if (compact.includes('light') || compact.includes('軽')) return '0';
    const fallback = compact.match(/(\d{1,2})/);
    if (fallback) {
      const n = parseInt(fallback[1], 10);
      if (n >= 0 && n <= 13) return String(n);
    }
    return '';
  }
  function parseLoadValue(value) {
    return normalizeLoadValue(value);
  }
  function collectCheckedLoadFilterValues(direction) {
    const container = document.getElementById(`filter-load-${direction}-options`);
    if (!container) return [];
    const values = Array.from(container.querySelectorAll('input[type="checkbox"]:checked'))
      .map(option => normalizeLoadValue(option.value))
      .filter(v => v !== '');
    return Array.from(new Set(values))
      .sort((a, b) => parseInt(a, 10) - parseInt(b, 10));
  }
  function setupLoadFilterOptions() {
    renderLoadFilterOptions('up');
    renderLoadFilterOptions('down');
  }
  function renderLoadFilterOptions(direction) {
    const container = document.getElementById(`filter-load-${direction}-options`);
    if (!container || !Object.prototype.hasOwnProperty.call(summaryLoad, direction)) return;
    const selected = Array.isArray(summaryLoad[direction]) ? summaryLoad[direction] : [];
    let html = '';
    for (let i = 0; i <= 13; i += 1) {
      const value = String(i);
      const inputId = `filter-load-${direction}-${value}`;
      const checked = selected.includes(value) ? ' checked' : '';
      html += `<input type="checkbox" id="${inputId}" value="${value}"${checked} onchange="updateLoadFilter('${direction}')">`;
      html += `<label class="load-filter-chip" for="${inputId}">${value}</label>`;
    }
    container.innerHTML = html;
  }
  function renderLoadFilterSelectionSummary(direction) {
    const target = document.getElementById(`filter-load-${direction}-selected`);
    const summary = document.getElementById(`filter-load-${direction}-summary`);
    if (!Object.prototype.hasOwnProperty.call(summaryLoad, direction)) return;
    const selected = Array.isArray(summaryLoad[direction]) ? summaryLoad[direction] : [];
    const summaryText = selected.length > 0 ? selected.join(', ') : 'すべて';
    if (target) target.textContent = `選択中: ${summaryText}`;
    if (summary) summary.textContent = summaryText;
  }
  function normalizeYesNoValue(value) {
    const v = (value || '').trim().toLowerCase();
    if (v === 'yes' || v === 'no') return v;
    return '';
  }
  function normalizeSpeedFilterValue(value) {
    return normalizeYesNoValue(value);
  }
  function isHakoneRouteDownValue(value) {
    const normalized = normalizeRouteValue(value);
    return normalized === '箱根ー新東名－新名神' ||
      normalized === '箱根ー新東名ー名神';
  }
  function isHakoneShindoEnabled(log) {
    if (!log) return false;
    return !!log.hakoneShindo || isHakoneRouteDownValue(getRoutePair(log).down);
  }
  function hakoneShindoLabel(log) {
    if (!isHakoneShindoEnabled(log)) return '';
    return '<span class="tag-primary">箱根新道</span>';
  }
  function speedMaxLabel(log) {
    const parts = [];
    if (log.speedUpMax) {
      parts.push('<span class="tag-primary">速度MAX:上り</span>');
    }
    if (log.speedDownMax) {
      parts.push('<span class="tag-primary">速度MAX:下り</span>');
    }
    if (parts.length === 0) return '';
    return parts.join(' ');
  }
  function escapeHtml(s) {
    return (s || '').replace(/[&<>"']/g, c => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;',
      '"': '&quot;', "'": '&#039;'
    })[c]);
  }
  function formatNumber(n) {
    if (!n && n !== 0) return '';
    return Number(n).toLocaleString('ja-JP', { maximumFractionDigits: 1 });
  }
</script>
</body>
</html>
